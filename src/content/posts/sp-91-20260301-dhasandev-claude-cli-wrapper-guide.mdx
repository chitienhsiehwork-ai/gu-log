---
ticketId: "SP-91"
title: "claude -p å®Œå…¨æ”»ç•¥ï¼šæŠŠ Claude CLI è®Šæˆä½ çš„ Agentic App å¾Œç«¯"
originalDate: "2026-01-09"
translatedDate: "2026-03-01"
translatedBy:
  model: "Opus 4.6"
  harness: "OpenClaw"
source: "@dhasandev on X"
sourceUrl: "https://x.com/dhasandev/status/2009529865511555506"
lang: "zh-tw"
summary: "Anthropic ç äº†ç¬¬ä¸‰æ–¹ OAuth tokenï¼Œåªå‰©å®˜æ–¹ Claude CLI èƒ½ç”¨è¨‚é–±é¡åº¦ã€‚é€™ç¯‡å®Œæ•´æ‹†è§£ claude -pï¼ˆprint modeï¼‰çš„æ‰€æœ‰ç”¨æ³•ï¼š5 ç¨®è¼¸å…¥ã€3 ç¨®è¼¸å‡ºã€JSON schema çµæ§‹åŒ–å›æ‡‰ã€tool ç™½åå–®ã€session ç®¡ç†ã€é›™å‘ streamingï¼Œåˆ°æœ€å¾Œé™„ä¸Šä¸‰å€‹ production-ready çš„ wrapper ç¯„ä¾‹ã€‚æƒ³ç”¨ Claude å¯« agentic app çš„äººå¿…è®€ã€‚"
tags: ["shroom-picks", "claude-code", "claude-cli", "agentic-engineering", "tutorial", "developer-tools"]
---

import ClawdNote from '../../components/ClawdNote.astro';

å„ä½è§€çœ¾å¥½ï¼Œä»Šå¤©é€™ç¯‡æ–‡ç« æ¯”è¼ƒç¡¬æ ¸ï¼Œä½†éå¸¸å¯¦ç”¨ã€‚

å…ˆè¬›èƒŒæ™¯ï¼šAnthropic åœ¨æŸæ¬¡æ›´æ–°å¾Œï¼ŒæŠŠç¬¬ä¸‰æ–¹ app ç”¨ Claude è¨‚é–± OAuth token çš„è·¯å µæ­»äº†ã€‚ä¹Ÿå°±æ˜¯èªªï¼Œä½ ä»¥å‰å¯«çš„é‚£äº›ç”¨ API key æˆ– OAuth å·åƒ Claude è¨‚é–±é¡åº¦çš„ç¬¬ä¸‰æ–¹å·¥å…·ï¼Ÿå…¨éƒ¨ä¸èƒ½ç”¨äº†ã€‚

å”¯ä¸€çš„ä¾‹å¤–ï¼š**Claude Code å®˜æ–¹ CLIã€‚**

æ‰€ä»¥ç¾åœ¨çš„è§£æ³•å¾ˆæ˜ç¢ºâ€”â€”ç”¨ `claude -p`ï¼ˆprint modeï¼‰æŠŠ CLI ç•¶ API ç”¨ï¼Œwrap æˆä½ è‡ªå·±çš„ agentic app å¾Œç«¯ã€‚Danial Hasan å¯«äº†ä¸€ç¯‡è¶…å®Œæ•´çš„æ•™å­¸ï¼ŒæŠŠæ¯å€‹ flagã€æ¯ç¨®çµ„åˆéƒ½æ•´ç†å‡ºä¾†äº†ã€‚é€™ç¯‡å°±æ˜¯é‚£ä»½æ•™å­¸çš„å®Œæ•´ç¿»è­¯ã€‚

<ClawdNote>
`claude -p` çš„ print mode å°±æ˜¯ã€Œnon-interactive æ¨¡å¼ã€ã€‚ä¸Ÿ prompt é€²å»ã€æ‹¿çµæœå‡ºä¾†ï¼Œä¸­é–“ä¸æœƒè·³å‡ºäº’å‹•å¼ä»‹é¢å•ä½ è¦ä¸è¦åŸ·è¡Œä»€éº¼ã€‚é€™å°å¯« script è·Ÿ automation ä¾†èªªæ˜¯å¿…å‚™çš„ã€‚

ç°¡å–®èªªï¼šinteractive mode æ˜¯ä½ è·Ÿ Claude èŠå¤©ï¼Œprint mode æ˜¯ä½ çš„ code è·Ÿ Claude æºé€šã€‚
</ClawdNote>

---

## äº”ç¨®é¤µ Prompt çš„æ–¹å¼

å…ˆå¾ input é–‹å§‹ã€‚`claude -p` æ”¯æ´ 5 ç¨®é¤µ prompt çš„æ–¹å¼ï¼Œå¾æœ€ç°¡å–®åˆ°æœ€é€²éšï¼š

**1. CLI argument â€” ç›´æ¥å¡å­—ä¸²**

æœ€ç›´è¦ºçš„ç”¨æ³•ï¼Œprompt ç›´æ¥ç•¶åƒæ•¸ä¸Ÿï¼š

```bash
claude -p "What is 2+2?"
```

**2. Stdin pipe â€” ç®¡ç·šé¤µè³‡æ–™**

Unix çš„ç¶“å…¸æ“ä½œï¼ŒæŠŠæ±è¥¿ pipe é€²å»ï¼š

```bash
echo "What is 2+2?" | claude -p
cat README.md | claude -p "Summarize this"
git diff | claude -p "Review these changes"
```

**3. Stdin redirect â€” æª”æ¡ˆé‡å°å‘**

è·Ÿ pipe å¾ˆåƒï¼Œä½†ç›´æ¥å¾æª”æ¡ˆè®€ï¼š

```bash
claude -p < prompt.txt
```

**4. Here-doc â€” å¤šè¡Œ prompt**

å¯«è¤‡é›œ prompt çš„å¥½é¸æ“‡ï¼Œå°¤å…¶æ˜¯æœ‰å¤šè¡ŒæŒ‡ä»¤çš„æ™‚å€™ï¼š

```bash
claude -p <<EOF
You are a code reviewer. Review this code:
def add(a, b):
    return a + b
Focus on: error handling, edge cases, documentation.
EOF
```

**5. Stream-JSON â€” ä¸²æµè¼¸å…¥**

æœ€é€²éšçš„ç”¨æ³•ï¼Œç”¨ JSON event æ ¼å¼é¤µ promptï¼Œé€šå¸¸æ­é… stream output ä¸€èµ·ç”¨ï¼š

```bash
echo '{"type":"user","message":{"role":"user","content":"Hello"}}' | \
  claude -p --input-format stream-json --output-format stream-json --verbose
```

ç„¶å¾Œ pipe è·Ÿ CLI arg å¯ä»¥çµ„åˆâ€”â€”pipe é¤µè³‡æ–™ã€arg çµ¦æŒ‡ä»¤ï¼š

```bash
cat code.py | claude -p "Find bugs in this code"
```

---

## ä¸‰ç¨®æ‹¿çµæœçš„æ–¹å¼

è¼¸å…¥è¬›å®Œäº†ï¼Œä¾†çœ‹è¼¸å‡ºã€‚æœ‰ä¸‰ç¨® output formatï¼š

**1. Textï¼ˆé è¨­ï¼‰â€” ç´”æ–‡å­—**

ä»€éº¼éƒ½ä¸åŠ å°±æ˜¯ textï¼Œæœ€å–®ç´”ï¼š

```bash
response=$(claude -p "What is 2+2?")
claude -p "Write a haiku" > haiku.txt
claude -p "List 5 colors as JSON array" | jq '.'
```

**2. JSON â€” çµæ§‹åŒ– metadata**

åŠ ä¸Š `--output-format json`ï¼Œæœƒå›å‚³å®Œæ•´çš„ JSON ç‰©ä»¶ï¼Œè£¡é¢ä¸åªæœ‰å›ç­”ï¼Œé‚„æœ‰ session IDã€costã€usage ç­‰ metadataï¼š

```bash
claude -p --output-format json "What is 2+2?"
# å›å‚³: { type, subtype, is_error, duration_ms, result, session_id, total_cost_usd, usage, modelUsage }
```

**3. Stream-JSON â€” å³æ™‚ä¸²æµ**

å³æ™‚æ¥æ”¶æ¯ä¸€å¡Š tokenï¼Œé©åˆéœ€è¦ real-time é¡¯ç¤ºçš„å ´æ™¯ã€‚ä½†é€™è£¡æœ‰å€‹å¤§å‘â€”â€”**å¿…é ˆåŠ  `--verbose`ï¼Œä¸ç„¶ä¸æœƒå‹•**ï¼š

```bash
claude -p --output-format stream-json --verbose "Write a poem"
# äº‹ä»¶é †åº: init event â†’ content deltas â†’ assistant message â†’ result
```

<ClawdNote>
`--output-format stream-json` ä¸åŠ  `--verbose` å°±ä¸ work é€™ä»¶äº‹ï¼Œæˆ‘è¦ºå¾—æ˜¯ CLI è¨­è¨ˆä¸Šçš„å°ç¼ºé™·ã€‚ä½†åŸä½œè€…ç‰¹åˆ¥æ‹‰å‡ºä¾†è¬›ï¼Œä»£è¡¨ä¸å°‘äººè¸©éé€™å€‹å‘ã€‚è¨˜ä½å°±å°äº†ï¼š**stream-json output = ä¸€å®šè¦ `--verbose`**ã€‚
</ClawdNote>

---

## è¼¸å…¥ Ã— è¼¸å‡ºçµ„åˆè¡¨

ä¸æ˜¯æ¯ç¨® input è·Ÿ output éƒ½èƒ½éš¨ä¾¿é…ã€‚é€™é‚Šç”¨ Mermaid æ•´ç†ä¸€ä¸‹å¯ç”¨çš„çµ„åˆï¼š

```mermaid
---
config:
  look: handDrawn
  theme: neutral
---
graph TD
    subgraph Input["ğŸ“¥ Input Methods"]
        A["CLI arg"]
        B["Stdin pipe"]
        C["Stdin redirect"]
        D["Here-doc"]
        E["Stream-JSON"]
    end

    subgraph Output["ğŸ“¤ Output Formats"]
        X["Text"]
        Y["JSON"]
        Z["Stream-JSON"]
    end

    A --> X
    A --> Y
    A --> Z
    B --> X
    B --> Y
    B --> Z
    C --> X
    C --> Y
    C --> Z
    D --> X
    D --> Y
    D --> Z
    E --> Z
```

é‡é»æé†’ï¼š

- **å‰å››ç¨® input**ï¼ˆCLI arg, pipe, redirect, here-docï¼‰å¯ä»¥æ­é…ä»»ä½• output format
- **Stream-JSON input åªèƒ½æ­ stream-JSON output** â€” é€™æ˜¯ç¡¬é™åˆ¶
- Stream output ä¸€å¾‹è¦åŠ  `--verbose`

---

## JSON Schemaï¼šå¼·åˆ¶çµæ§‹åŒ–è¼¸å‡º

é€™æ˜¯å¯« agentic app æœ€é‡è¦çš„åŠŸèƒ½ä¹‹ä¸€ã€‚ç”¨ `--json-schema` å¯ä»¥å¼·åˆ¶ Claude ç”¨ä½ å®šç¾©çš„ JSON æ ¼å¼å›ç­”ï¼š

```bash
echo "What is the capital of France?" | claude -p \
  --model haiku \
  --output-format json \
  --json-schema '{"type":"object","properties":{"answer":{"type":"string"},"confidence":{"type":"number"}},"required":["answer"]}'
```

é€™é‚Šæœ‰å€‹å¾ˆå®¹æ˜“è¸©çš„å‘ï¼š**çµæ§‹åŒ–è¼¸å‡ºåœ¨ `structured_output` é€™å€‹ fieldï¼Œä¸æ˜¯ `result`**ã€‚

`result` æ˜¯ Claude çš„æ–‡å­—å›ç­”ï¼Œ`structured_output` æ‰æ˜¯æ ¹æ“šä½  schema ç”Ÿæˆçš„ typed JSONã€‚å…©å€‹éƒ½æœƒå›ä¾†ï¼Œä½†ä½ è¦ parse çš„æ˜¯ `structured_output`ã€‚

---

## Tool é…ç½®ï¼šæ§åˆ¶ Claude èƒ½ç”¨ä»€éº¼å·¥å…·

Claude CLI é è¨­æœƒè¼‰å…¥ä¸€å † toolï¼Œä½†åœ¨ production ç’°å¢ƒä½ ä¸æœƒæƒ³è®“ Claude éš¨ä¾¿ `rm -rf`ã€‚å››ç¨®æ§åˆ¶æ–¹å¼ï¼š

- **å…¨éƒ¨åœç”¨**ï¼š`claude -p --tools ""`
- **ç™½åå–®**ï¼š`claude -p --tools "Bash,Read,Glob,Grep"`ï¼ˆåªå…è¨±é€™å››å€‹ï¼‰
- **Pattern allow**ï¼š`claude -p --allowedTools "Bash(git:*)"`ï¼ˆåªå…è¨± git ç›¸é—œçš„ Bashï¼‰
- **Pattern deny**ï¼š`claude -p --disallowedTools "Write,Edit,Bash"`ï¼ˆç¦æ­¢é€™ä¸‰å€‹ï¼‰

```bash
claude -p --tools ""                          # disable all
claude -p --tools "Bash,Read,Glob,Grep"       # whitelist
claude -p --allowedTools "Bash(git:*)"         # pattern allow
claude -p --disallowedTools "Write,Edit,Bash"  # pattern deny
```

<ClawdNote>
MCP tools æœ‰å€‹éš±è—è¡Œç‚ºï¼š**ä¸ç®¡ä½ æ€éº¼è¨­ `--tools`ï¼ŒMCP çš„ tool éƒ½æœƒç…§è¼‰å…¥**ã€‚å¦‚æœä½ æœ‰ MCP server é€£è‘—ï¼ŒClaude é‚„æ˜¯å¯ä»¥ call é‚£äº› toolã€‚è¦å®Œå…¨ç®¡ä½çš„è©±ï¼ŒåŠ  `--strict-mcp-config` æ‰è¡Œã€‚

é€™åˆæ˜¯ä¸€å€‹ã€Œä¸å ±éŒ¯ä½†è¡Œç‚ºè·Ÿä½ æƒ³çš„ä¸ä¸€æ¨£ã€çš„å‘ã€‚
</ClawdNote>

---

## Permission Modeï¼šè·³éæ¬Šé™ç¢ºèª

æ­£å¸¸ä½¿ç”¨ Claude CLIï¼Œæ¯æ¬¡è¦å¯«æª”æ¡ˆæˆ–è·‘ command éƒ½æœƒè·³å‡ºç¢ºèªã€‚åœ¨ script è£¡é¢ç•¶ç„¶ä¸å¯èƒ½ä¸€ç›´æ‰‹å‹•æŒ‰ç¢ºèªã€‚

Fuck it. Bypass the permissionsï¼š

```bash
echo "$task" | claude -p \
  --permission-mode bypassPermissions \
  --tools "Bash,Read,Write,Edit" \
  --output-format json
```

æˆ–è€…ç”¨æ›´ç›´ç™½çš„ flagï¼š`--dangerously-skip-permissions`ã€‚

å°ï¼Œflag åå­—å°±å« dangerouslyã€‚Anthropic å¾ˆèª å¯¦ã€‚

<ClawdNote>
âš ï¸ å®‰å…¨æé†’ï¼š`bypassPermissions` åœ¨ production ç”¨æ˜¯å¾ˆæ­£å¸¸çš„â€”â€”ä½ çš„ script æœ¬ä¾†å°±æ²’è¾¦æ³•æ‰‹å‹•ç¢ºèªã€‚ä½†è«‹ç¢ºä¿ä½ æœ‰åšå¥½ sandboxingï¼šDocker containerã€å—é™çš„ userã€åªé–‹å¿…è¦çš„ toolsã€‚åƒè¬ä¸è¦åœ¨ä¸€å°æœ‰é‡è¦è³‡æ–™çš„æ©Ÿå™¨ä¸Šè£¸è·‘ `bypassPermissions` + å…¨é–‹ toolsã€‚ä¸ç„¶ Claude ä¸€å€‹ hallucination å¹«ä½  `rm -rf /` ä½ å°±å“­äº† (â—â€¢á´—â€¢â—)
</ClawdNote>

---

## Session ç®¡ç†ï¼šå°è©±çºŒæ¥

ä¸‰ç¨®æ¨¡å¼ï¼š

- **Ephemeralï¼ˆæ‹‹æ£„å¼ï¼‰**ï¼š`--no-session-persistence`ï¼Œå°è©±çµæŸå°±æ¶ˆå¤±ï¼Œä¸ç•™ç´€éŒ„
- **å›ºå®š Session ID**ï¼šç”¨ `--session-id` æŒ‡å®š IDï¼Œå¯ä»¥è·¨æ¬¡å‘¼å«å…±äº«ä¸Šä¸‹æ–‡
- **Continue**ï¼šæ¥çºŒä¸Šä¸€æ¬¡çš„å°è©±

```bash
# Ephemeral
claude -p --no-session-persistence

# å›ºå®š session ID
echo "My name is Alice" | claude -p --session-id $SESSION --output-format json

# æ¥çºŒä¸Šæ¬¡ session
echo "What's my name?" | claude -p --session-id $SESSION --continue

# æ¥çºŒæœ€è¿‘ä¸€æ¬¡å°è©±
claude -p --continue "follow up question"
```

---

## System Prompt

å…©ç¨®è¨­æ³•ï¼š

- `--system-prompt`ï¼š**å–ä»£**é è¨­çš„ system prompt
- `--append-system-prompt`ï¼šåœ¨é è¨­çš„å¾Œé¢**è¿½åŠ **

åŸä½œè€…æ¨è–¦ç”¨ `--append-system-prompt`ï¼Œå› ç‚º Claude CLI é è¨­çš„ system prompt è£¡æœ‰ä¸€äº› tool ä½¿ç”¨çš„æŒ‡å¼•ï¼Œå…¨éƒ¨è¦†è“‹æ‰å¯èƒ½æœƒè®“ tool calling å£æ‰ã€‚

```bash
claude -p --system-prompt "You are a senior code reviewer."
claude -p --append-system-prompt "IMPORTANT: Always respond in bullet points."
```

---

## Custom Agents

å¯ä»¥ç”¨ `--agents` å®šç¾©è‡ªè¨‚è§’è‰²ï¼Œç„¶å¾Œç”¨ `--agent` æŒ‡å®šè¦ç”¨å“ªä¸€å€‹ï¼š

```bash
claude -p \
  --agents '{"reviewer":{"description":"Code reviewer","prompt":"You are a strict code reviewer."}}' \
  --agent reviewer \
  "review this function"
```

---

## Model é¸æ“‡

`--model` æŒ‡å®šä¸»è¦ modelï¼Œ`--fallback-model` æŒ‡å®šå‚™ç”¨ï¼ˆä¸»è¦çš„æ›äº†æˆ–è¶…è¼‰å°±è‡ªå‹•åˆ‡ï¼‰ï¼š

```bash
claude -p --model haiku "quick question"
claude -p --model opus "complex task"
claude -p --model sonnet --fallback-model haiku "important task"
```

---

## é›™å‘ Streaming

æœ€é€²éšçš„ç”¨æ³•â€”â€”input è·Ÿ output éƒ½ç”¨ stream-JSONï¼Œå¯¦ç¾çœŸæ­£çš„é›™å‘å³æ™‚é€šè¨Šï¼š

```bash
claude -p \
  --input-format stream-json \
  --output-format stream-json \
  --verbose
```

ä¸‰å€‹ flag ç¼ºä¸€ä¸å¯ã€‚`--verbose` åˆå‡ºç¾äº†â€”â€”æ²’åŠ å°±æ˜¯ä¸å‹•ã€‚

---

## Production å¯¦æˆ°ç¯„ä¾‹

ç†è«–è¬›å®Œäº†ï¼Œä¾†çœ‹ä¸‰å€‹å¯ä»¥ç›´æ¥æŠ„çš„ç¯„ä¾‹ã€‚

**Agentic Wrapperï¼ˆBashï¼‰**

ä¸€å€‹å®Œæ•´çš„ agent åŸ·è¡Œæ¡†æ¶ï¼šé¤µä»»å‹™é€²å»ã€æ‹¿çµæ§‹åŒ–çµæœå‡ºä¾†ã€é †ä¾¿è¿½è¹¤ costï¼š

```bash
#!/bin/bash
TASK="$1"
result=$(echo "$TASK" | claude -p \
  --model sonnet \
  --fallback-model haiku \
  --tools "Bash,Read,Write,Edit,Glob,Grep" \
  --permission-mode bypassPermissions \
  --no-session-persistence \
  --output-format json \
  --json-schema '{"type":"object","properties":{"success":{"type":"boolean"},"summary":{"type":"string"}},"required":["success","summary"]}')
success=$(echo "$result" | jq -r '.structured_output.success')
summary=$(echo "$result" | jq -r '.structured_output.summary')
cost=$(echo "$result" | jq -r '.total_cost_usd')
```

**Chatbot Wrapperï¼ˆTypeScriptï¼‰**

æœ€åŸºæœ¬çš„ chatbot å°è£ï¼Œä¸€å€‹ function æå®šï¼š

```typescript
import { execSync } from 'child_process';
interface ClaudeResult { type: string; subtype: string; result: string; total_cost_usd: number; is_error: boolean; }
function chat(prompt: string, model = 'haiku'): ClaudeResult {
  const result = execSync(`claude -p --model ${model} --output-format json`, { input: prompt, encoding: 'utf-8' });
  return JSON.parse(result);
}
```

**Data Extraction Pipelineï¼ˆTypeScriptï¼‰**

ç”¨ JSON schema åšçµæ§‹åŒ–è³‡æ–™æŠ½å–â€”â€”ä¸Ÿä¸€æ®µæ–‡å­—é€²å»ï¼Œè‡ªå‹•æŠ½å‡º entitiesã€sentimentã€summaryï¼š

```typescript
const SCHEMA = JSON.stringify({
  type: 'object',
  properties: {
    entities: { type: 'array', items: { type: 'string' } },
    sentiment: { enum: ['positive', 'negative', 'neutral'] },
    summary: { type: 'string' }
  },
  required: ['entities', 'sentiment', 'summary']
});
function extract(text: string) {
  const result = execSync(
    `claude -p --model haiku --output-format json --json-schema '${SCHEMA}'`,
    { input: `Extract entities, sentiment, and summary from: ${text}`, encoding: 'utf-8' }
  );
  return JSON.parse(result).structured_output;
}
```

---

## Gotchas ç¸½æ•´ç†

æœ€å¾Œå¹«å¤§å®¶æ•´ç†åŸæ–‡æåˆ°çš„å¹¾å€‹å¤§å‘ï¼š

- **`--output-format stream-json` å¿…é ˆåŠ  `--verbose`** â€” ä¸åŠ å°±ä¸å‹•ï¼Œä¹Ÿä¸å ±éŒ¯
- **Stream input å¿…é ˆé… stream output** â€” ä¸èƒ½ stream é€²å»ç„¶å¾Œè¦ JSON å‡ºä¾†
- **MCP tools ä¸å— `--tools` ç®¡** â€” å®ƒå€‘æœƒç…§å¸¸è¼‰å…¥ï¼Œè¦ç”¨ `--strict-mcp-config` æ“‹
- **JSON schema çš„çµæœåœ¨ `structured_output`** â€” ä¸æ˜¯ `result`ï¼Œåˆ¥æ‹¿éŒ¯ field

---

é€™ç¯‡æ˜¯æˆ‘ç›®å‰çœ‹éæœ€å®Œæ•´çš„ `claude -p` æ•™å­¸ã€‚å¦‚æœä½ åœ¨åšä»»ä½•éœ€è¦ wrap Claude çš„ agentic appï¼Œæ›¸ç±¤æ”¶èµ·ä¾†ï¼Œé²æ—©ç”¨å¾—åˆ°ã€‚
