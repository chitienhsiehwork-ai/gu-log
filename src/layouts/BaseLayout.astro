---
import ThemeToggle from '../components/ThemeToggle.astro';
import LanguageToggle from '../components/LanguageToggle.astro';
import SearchBar from '../components/SearchBar.astro';
import CodeCopyButton from '../components/CodeCopyButton.astro';
import ReadingProgress from '../components/ReadingProgress.astro';
import BackToTop from '../components/BackToTop.astro';
import LoginIndicator from '../components/LoginIndicator.astro';

interface Props {
  title: string;
  description?: string;
  lang?: 'zh-tw' | 'en';
  image?: string;
}

const { title, description, lang = 'zh-tw', image } = Astro.props;

const currentPath = Astro.url.pathname;
const canonicalURL = new URL(currentPath, Astro.site).href;
const ogImage = image ? new URL(image, Astro.site).href : new URL('/og-image.png', Astro.site).href;

// i18n content
const i18n = {
  'zh-tw': {
    htmlLang: 'zh-TW',
    defaultDescription: '香菇大狗狗的翻譯閱讀筆記 - ShroomDog and Clawd',
    siteTitle: '香菇大狗狗',
    homeLink: '/',
    navHome: '首頁',
    navAbout: '關於',
    aboutLink: '/about',
    footerBy: '香菇大狗狗',
    footerSub: '翻譯由 Clawd 執行，（沒什麼）經人工校對',
    fonts:
      'https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Noto+Sans+TC:wght@400;500;700&display=swap',
  },
  en: {
    htmlLang: 'en',
    defaultDescription: "ShroomDog's Tech Notes - Making AI Fun Again",
    siteTitle: 'ShroomDog',
    homeLink: '/en',
    navHome: 'Home',
    navAbout: 'About',
    aboutLink: '/en/about',
    footerBy: 'ShroomDog',
    footerSub: 'Written by AI, (barely) reviewed by humans',
    fonts: 'https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap',
  },
};

const t = i18n[lang];
const finalDescription = description || t.defaultDescription;
---

<!doctype html>
<html lang={t.htmlLang}>
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta name="description" content={finalDescription} />
    <meta name="apple-mobile-web-app-title" content="ShroomDog" />

    <!-- Open Graph / Facebook -->
    <meta property="og:type" content="website" />
    <meta property="og:url" content={canonicalURL} />
    <meta property="og:title" content={title} />
    <meta property="og:description" content={finalDescription} />
    <meta property="og:image" content={ogImage} />

    <!-- Twitter -->
    <meta name="twitter:card" content="summary" />
    <meta name="twitter:url" content={canonicalURL} />
    <meta name="twitter:title" content={title} />
    <meta name="twitter:description" content={finalDescription} />
    <meta name="twitter:image" content={ogImage} />

    <!-- Canonical URL -->
    <link rel="canonical" href={canonicalURL} />

    <!-- RSS Feed -->
    <link rel="alternate" type="application/rss+xml" title="香菇大狗狗 RSS Feed" href="/rss.xml" />

    <link rel="icon" type="image/svg+xml" href="/favicon.svg" />
    <link rel="apple-touch-icon" href="/apple-touch-icon.png" />
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link href={t.fonts} rel="stylesheet" />
    <title>{title}</title>
    <!-- Prevent flash of wrong theme -->
    <script is:inline>
      const theme = localStorage.getItem('theme') || 'dark';
      document.documentElement.setAttribute('data-theme', theme);
    </script>
    <style is:global>
      @import '../styles/global.css';
    </style>
    <style>
      .site-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 0.5rem 0;
        margin-bottom: 2rem;
        border-bottom: 1px solid var(--color-border);
        flex-wrap: wrap;
        gap: 0.25rem 0.5rem;
        min-height: 44px;
      }

      .header-avatar {
        width: 36px;
        height: 36px;
        border-radius: 22%;
        vertical-align: middle;
        margin-right: 0.3rem;
        flex-shrink: 0;
      }

      .site-title {
        display: flex;
        align-items: center;
        font-size: 1rem;
        font-weight: 600;
        color: var(--color-text);
        text-decoration: none;
        white-space: nowrap;
        flex-shrink: 0;
      }

      .site-title-text {
        white-space: nowrap;
      }

      .site-nav {
        display: flex;
        align-items: center;
        gap: 0.5rem;
        flex-shrink: 0;
      }

      .nav-link {
        color: var(--color-text-muted);
        font-size: 0.75rem;
        white-space: nowrap;
        text-decoration: none;
        min-height: 48px;
        display: inline-flex;
        align-items: center;
        padding: 0 0.25rem;
      }

      .nav-link:hover {
        color: var(--color-accent);
      }

      .nav-icons {
        display: flex;
        align-items: center;
        gap: 0.1rem;
      }

      .clawd-nav-link {
        display: flex;
        align-items: center;
        justify-content: center;
        min-width: 48px;
        min-height: 48px;
      }

      .clawd-nav-icon {
        width: 18px;
        height: 18px;
        opacity: 0.7;
        transition:
          opacity 0.2s,
          transform 0.2s;
      }

      .clawd-nav-link:hover .clawd-nav-icon {
        opacity: 1;
        transform: scale(1.1);
      }

      /* Mobile: allow header to wrap, keep items compact */
      @media (max-width: 480px) {
        .site-header {
          flex-wrap: wrap;
        }
        .site-nav {
          flex-shrink: 1;
          flex-wrap: wrap;
          gap: 0.2rem;
          justify-content: flex-end;
        }
        .nav-link {
          font-size: 0.7rem;
          min-height: 36px;
          padding: 0 0.15rem;
        }
        .nav-icons {
          gap: 0;
        }
        .clawd-nav-link {
          min-width: 36px;
          min-height: 36px;
        }
      }

      .site-footer {
        margin-top: 3rem;
        padding-top: 1rem;
        border-top: 1px solid var(--color-border);
        color: var(--color-text-muted);
        font-size: 0.85rem;
        text-align: center;
      }

      .footer-sub {
        font-size: 0.75rem;
        margin-top: 0.25rem;
      }

      .footer-rss {
        font-size: 0.75rem;
        margin-top: 0.5rem;
      }

      .footer-rss a {
        color: var(--color-accent);
        text-decoration: none;
      }

      .footer-rss a:hover {
        text-decoration: underline;
      }

      main {
        min-height: 60vh;
      }
    </style>
  </head>
  <body>
    <ReadingProgress />
    <div class="container">
      <header class="site-header">
        <a href={t.homeLink} class="site-title"
          ><img src="/gu-log-icon-trimmed.png" alt="" class="header-avatar" /><span
            class="site-title-text">{t.siteTitle}</span
          ></a
        >
        <nav class="site-nav">
          <a href={t.homeLink} class="nav-link">{t.navHome}</a>
          <a href={t.aboutLink} class="nav-link">{t.navAbout}</a>
          <span class="nav-icons">
            <LoginIndicator lang={lang} />
            <LanguageToggle currentLang={lang} currentPath={currentPath} />
            <a href={`${t.homeLink}#clawd-picks`} class="clawd-nav-link" title="Clawd Picks"
              ><img src="/clawd-picks-icon.png" alt="Clawd Picks" class="clawd-nav-icon" /></a
            >
            <SearchBar lang={lang} />
            <ThemeToggle />
          </span>
        </nav>
      </header>

      <main>
        <slot />
      </main>

      <footer class="site-footer">
        <p>
          by <strong>{t.footerBy}</strong>
          {lang === 'zh-tw' ? '/ ShroomDog and Clawd' : 'and Clawd'}
        </p>
        <p class="footer-sub">{t.footerSub}</p>
        <p class="footer-rss"><a href="/rss.xml">RSS</a></p>
      </footer>
    </div>

    <CodeCopyButton />
    <BackToTop lang={lang} />
  </body>
</html>
