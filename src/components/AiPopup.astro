---
/**
 * AiPopup Component
 *
 * Text selection popup for AI interactions (Ask AI / Edit with AI).
 * Triggers on text selection within .post-content areas.
 * Supports dark/light themes, desktop floating + mobile bottom sheet.
 */

interface Props {
  filePath?: string;
  postTitle?: string;
  lang?: 'zh-tw' | 'en';
}

const { filePath = '', postTitle = '', lang = 'zh-tw' } = Astro.props;

const apiUrl = import.meta.env.PUBLIC_API_URL || 'https://api.shroomdog.dev';
---

<div
  id="ai-popup-root"
  data-file-path={filePath}
  data-post-title={postTitle}
  data-api-url={apiUrl}
  data-lang={lang}
>
  <!-- Popup is created dynamically by JS -->
</div>

<script is:inline>
  (function () {
    'use strict';

    const JWT_KEY = 'gu-log-jwt';
    const RETURN_KEY = 'gu-log-return-url';

    const root = document.getElementById('ai-popup-root');
    if (!root) return;

    const filePath = root.getAttribute('data-file-path') || '';
    const postTitle = root.getAttribute('data-post-title') || '';
    const apiUrl = root.getAttribute('data-api-url') || '';
    const lang = root.getAttribute('data-lang') || 'zh-tw';

    // i18n
    const t =
      lang === 'en'
        ? {
            askAi: 'ü§ñ Ask AI',
            edit: '‚úèÔ∏è Edit',
            login: 'üîê Login with GitHub',
            loading: 'Thinking...',
            close: '‚úï',
            confirm: '‚úÖ Confirm',
            cancel: '‚ùå Cancel',
            committed: 'Committed!',
            error: 'Something went wrong. Please try again.',
            submit: 'Submit',
            cancelAsk: 'Cancel',
            questionPlaceholder: "What's your question?",
            editPlaceholder: 'How should this be changed? e.g. "fix typo", "make it more casual"',
            submitEdit: 'Submit',
            cancelEdit: 'Cancel',
            accept: '‚úÖ Accept',
            retry: 'üîÑ Retry',
            reject: '‚ùå Reject',
            networkError: 'Cannot connect to API server. Please check your network.',
            unknownError: 'An unknown error occurred.',
          }
        : {
            askAi: 'ü§ñ Ask AI',
            edit: '‚úèÔ∏è Edit',
            login: 'üîê Login with GitHub',
            loading: 'ÊÄùËÄÉ‰∏≠...',
            close: '‚úï',
            confirm: '‚úÖ Á¢∫Ë™ç',
            cancel: '‚ùå ÂèñÊ∂à',
            committed: 'Â∑≤Êèê‰∫§ÔºÅ',
            error: 'ÁôºÁîüÈåØË™§ÔºåË´ãÂÜçË©¶‰∏ÄÊ¨°„ÄÇ',
            submit: 'ÈÄÅÂá∫',
            cancelAsk: 'ÂèñÊ∂à',
            questionPlaceholder: 'ÊÉ≥Âïè‰ªÄÈ∫ºÔºü‰æãÂ¶ÇÔºösource code ÊòØÊÄéÈ∫ºËôïÁêÜÁöÑÔºü',
            editPlaceholder: 'ÊÉ≥ÊÄéÈ∫ºÊîπÔºü‰æãÂ¶ÇÔºö„Äå‰øÆ typo„Äç„ÄåË™ûÊ∞£ËºïÈ¨Ü‰∏ÄÈªû„Äç',
            submitEdit: 'ÈÄÅÂá∫',
            cancelEdit: 'ÂèñÊ∂à',
            accept: '‚úÖ Êé•Âèó',
            retry: 'üîÑ ÈáçË©¶',
            reject: '‚ùå ÊîæÊ£Ñ',
            networkError: 'ÁÑ°Ê≥ïÈÄ£Á∑öÂà∞ API ‰º∫ÊúçÂô®ÔºåË´ãÁ¢∫Ë™çÁ∂≤Ë∑ØÈÄ£Á∑ö',
            unknownError: 'ÁôºÁîüÊú™Áü•ÈåØË™§',
          };

    let popup = null;
    let selectedText = '';
    let currentState = 'idle'; // idle, buttons, ask-input, loading, ask-result, edit-input, edit-result, confirm-loading, committed, error
    let pendingEditId = null;
    let lastEditInstruction = '';

    function getJwt() {
      try {
        return localStorage.getItem(JWT_KEY);
      } catch (_error) {
        return null;
      }
    }

    function isLoggedIn() {
      return !!getJwt();
    }

    function escapeHtml(str) {
      const div = document.createElement('div');
      div.textContent = str;
      return div.innerHTML;
    }

    function createPopup() {
      if (popup) popup.remove();

      popup = document.createElement('div');
      popup.id = 'ai-popup';
      popup.className = 'ai-popup';
      popup.setAttribute('role', 'dialog');
      popup.setAttribute('aria-label', 'AI Popup');
      document.body.appendChild(popup);
      return popup;
    }

    function removePopup() {
      if (popup) {
        popup.remove();
        popup = null;
      }
      currentState = 'idle';
      pendingEditId = null;
    }

    function positionPopup(rect) {
      if (!popup) return;

      const isMobile = window.innerWidth < 640;

      if (isMobile) {
        // Bottom sheet style
        popup.classList.add('ai-popup--mobile');
        popup.classList.remove('ai-popup--desktop');
      } else {
        // Float near selection
        popup.classList.remove('ai-popup--mobile');
        popup.classList.add('ai-popup--desktop');

        const popupRect = popup.getBoundingClientRect();
        let top = rect.top + window.scrollY - popupRect.height - 8;
        let left = rect.left + window.scrollX + rect.width / 2 - popupRect.width / 2;

        // Keep within viewport
        if (top < window.scrollY + 8) {
          top = rect.bottom + window.scrollY + 8;
        }
        left = Math.max(8, Math.min(left, window.innerWidth - popupRect.width - 8));

        popup.style.top = top + 'px';
        popup.style.left = left + 'px';
      }
    }

    function renderButtons() {
      if (!popup) return;
      currentState = 'buttons';

      if (!isLoggedIn()) {
        popup.innerHTML =
          '<button class="ai-popup-btn ai-popup-btn--login" data-action="login">' +
          escapeHtml(t.login) +
          '</button>';
      } else {
        popup.innerHTML =
          '<button class="ai-popup-btn ai-popup-btn--ask" data-action="ask">' +
          escapeHtml(t.askAi) +
          '</button>' +
          '<button class="ai-popup-btn ai-popup-btn--edit" data-action="edit">' +
          escapeHtml(t.edit) +
          '</button>';
      }
    }

    function renderLoading() {
      if (!popup) return;
      currentState = 'loading';

      popup.innerHTML =
        '<div class="ai-popup-loading">' +
        '<div class="ai-popup-spinner"></div>' +
        '<span>' +
        escapeHtml(t.loading) +
        '</span>' +
        '</div>';
    }

    function renderAskInput() {
      if (!popup) return;
      currentState = 'ask-input';

      const content = document.createElement('div');
      content.className = 'ai-popup-ask-input-container';

      const input = document.createElement('input');
      input.type = 'text';
      input.className = 'ai-popup-question-input';
      input.placeholder = t.questionPlaceholder;
      input.setAttribute('aria-label', t.questionPlaceholder);

      const actions = document.createElement('div');
      actions.className = 'ai-popup-actions';
      actions.innerHTML =
        '<button class="ai-popup-btn ai-popup-btn--ask" data-action="submit-ask">' +
        escapeHtml(t.submit) +
        '</button>' +
        '<button class="ai-popup-btn ai-popup-btn--cancel" data-action="cancel-ask">' +
        escapeHtml(t.cancelAsk) +
        '</button>';

      content.appendChild(input);
      content.appendChild(actions);

      popup.innerHTML = '';
      popup.appendChild(content);

      // Focus the input
      input.focus();

      // Allow Enter key to submit
      input.addEventListener('keydown', function (e) {
        if (e.key === 'Enter') {
          e.preventDefault();
          handleSubmitAsk();
        }
      });

      positionPopup(getSelectionRect() || { top: 0, left: 0, bottom: 0, width: 0 });
    }

    function renderAskResult(response) {
      if (!popup) return;
      currentState = 'ask-result';

      const content = document.createElement('div');
      content.className = 'ai-popup-result';

      const closeBtn = document.createElement('button');
      closeBtn.className = 'ai-popup-close';
      closeBtn.setAttribute('data-action', 'close');
      closeBtn.textContent = t.close;

      const body = document.createElement('div');
      body.className = 'ai-popup-result-body';
      body.textContent = response;

      content.appendChild(closeBtn);
      content.appendChild(body);

      popup.innerHTML = '';
      popup.appendChild(content);

      // Re-position for larger content
      positionPopup(getSelectionRect() || { top: 0, left: 0, bottom: 0, width: 0 });
    }

    function renderEditResult(diff, editId) {
      if (!popup) return;
      currentState = 'edit-result';
      pendingEditId = editId;

      var content = document.createElement('div');
      content.className = 'ai-popup-result';

      var closeBtn = document.createElement('button');
      closeBtn.className = 'ai-popup-close';
      closeBtn.setAttribute('data-action', 'reject');
      closeBtn.textContent = t.close;

      var diffEl = document.createElement('div');
      diffEl.className = 'ai-popup-diff';

      // Render diff lines
      var lines = diff.split('\n');
      for (var i = 0; i < lines.length; i++) {
        var line = lines[i];
        var lineEl = document.createElement('div');
        lineEl.className = 'ai-popup-diff-line';
        if (line.indexOf('+') === 0 && line.indexOf('+++') !== 0) {
          lineEl.className += ' ai-popup-diff-add';
        } else if (line.indexOf('-') === 0 && line.indexOf('---') !== 0) {
          lineEl.className += ' ai-popup-diff-remove';
        }
        lineEl.textContent = line;
        diffEl.appendChild(lineEl);
      }

      var actions = document.createElement('div');
      actions.className = 'ai-popup-actions';
      actions.innerHTML =
        '<button class="ai-popup-btn ai-popup-btn--confirm" data-action="accept">' +
        escapeHtml(t.accept) +
        '</button>' +
        '<button class="ai-popup-btn ai-popup-btn--retry" data-action="retry">' +
        escapeHtml(t.retry) +
        '</button>' +
        '<button class="ai-popup-btn ai-popup-btn--cancel" data-action="reject">' +
        escapeHtml(t.reject) +
        '</button>';

      content.appendChild(closeBtn);
      content.appendChild(diffEl);
      content.appendChild(actions);

      popup.innerHTML = '';
      popup.appendChild(content);

      positionPopup(getSelectionRect() || { top: 0, left: 0, bottom: 0, width: 0 });
    }

    function renderCommitted(commitHash) {
      if (!popup) return;
      currentState = 'committed';

      popup.innerHTML =
        '<div class="ai-popup-result">' +
        '<button class="ai-popup-close" data-action="close">' +
        escapeHtml(t.close) +
        '</button>' +
        '<div class="ai-popup-committed">' +
        '<span class="ai-popup-committed-icon">‚úÖ</span> ' +
        escapeHtml(t.committed) +
        (commitHash ? ' <code>' + escapeHtml(commitHash.substring(0, 7)) + '</code>' : '') +
        '</div>' +
        '</div>';
    }

    function renderError(msg) {
      if (!popup) return;
      currentState = 'error';

      popup.innerHTML =
        '<div class="ai-popup-result ai-popup-result--error">' +
        '<button class="ai-popup-close" data-action="close">' +
        escapeHtml(t.close) +
        '</button>' +
        '<div class="ai-popup-error-text">' +
        escapeHtml(msg || t.error) +
        '</div>' +
        '</div>';
    }

    function getSelectionRect() {
      const sel = window.getSelection();
      if (!sel || sel.rangeCount === 0) return null;
      const range = sel.getRangeAt(0);
      const rect = range.getBoundingClientRect();
      if (rect.width === 0 && rect.height === 0) return null;
      return rect;
    }

    function isInsidePostContent(node) {
      let el = node.nodeType === 3 ? node.parentElement : node;
      while (el) {
        if (el.classList && el.classList.contains('post-content')) return true;
        el = el.parentElement;
      }
      return false;
    }

    async function apiRequest(endpoint, body) {
      const jwt = getJwt();
      const headers = { 'Content-Type': 'application/json' };
      if (jwt) headers['Authorization'] = 'Bearer ' + jwt;

      let res;
      try {
        res = await fetch(apiUrl + endpoint, {
          method: 'POST',
          headers: headers,
          body: JSON.stringify(body),
        });
      } catch (_error) {
        // Network error (TypeError: Failed to fetch)
        throw new Error(t.networkError);
      }

      if (!res.ok) {
        let errText = '';
        try {
          const errBody = await res.json();
          errText = errBody.detail || errBody.error || res.statusText;
        } catch (_error) {
          errText = res.statusText;
        }
        throw new Error(errText || t.unknownError);
      }

      return res.json();
    }

    async function handleAsk() {
      renderAskInput();
    }

    async function handleSubmitAsk() {
      const input = popup ? popup.querySelector('.ai-popup-question-input') : null;
      const question = input ? input.value.trim() : '';

      renderLoading();
      try {
        const body = {
          text: selectedText,
          context: postTitle,
        };
        if (question) {
          body.question = question;
        }
        const data = await apiRequest('/ai/ask', body);
        renderAskResult(data.response || data.answer || JSON.stringify(data));
      } catch (err) {
        renderError(err.message);
      }
    }

    function renderEditInput(prefill) {
      if (!popup) return;
      currentState = 'edit-input';

      var content = document.createElement('div');
      content.className = 'ai-popup-edit-input-container';

      var input = document.createElement('input');
      input.type = 'text';
      input.className = 'ai-popup-edit-input';
      input.placeholder = t.editPlaceholder;
      input.setAttribute('aria-label', t.editPlaceholder);
      if (prefill) input.value = prefill;

      var actions = document.createElement('div');
      actions.className = 'ai-popup-actions';
      actions.innerHTML =
        '<button class="ai-popup-btn ai-popup-btn--edit" data-action="submit-edit">' +
        escapeHtml(t.submitEdit) +
        '</button>' +
        '<button class="ai-popup-btn ai-popup-btn--cancel" data-action="cancel-edit">' +
        escapeHtml(t.cancelEdit) +
        '</button>';

      content.appendChild(input);
      content.appendChild(actions);

      popup.innerHTML = '';
      popup.appendChild(content);

      input.focus();

      input.addEventListener('keydown', function (e) {
        if (e.key === 'Enter') {
          e.preventDefault();
          handleSubmitEdit();
        }
      });

      positionPopup(getSelectionRect() || { top: 0, left: 0, bottom: 0, width: 0 });
    }

    async function handleEdit() {
      renderEditInput(lastEditInstruction);
    }

    async function handleSubmitEdit() {
      var input = popup ? popup.querySelector('.ai-popup-edit-input') : null;
      var instruction = input ? input.value.trim() : '';
      if (!instruction) {
        if (input) input.focus();
        return;
      }
      lastEditInstruction = instruction;

      renderLoading();
      try {
        var body = {
          selectedText: selectedText,
          filePath: filePath,
          instruction: instruction,
        };

        // Try to capture screenshot of selection area
        try {
          var screenshot = await captureSelectionScreenshot();
          if (screenshot) body.screenshot = screenshot;
        } catch (_err) {
          // Screenshot is optional, continue without it
        }

        var data = await apiRequest('/ai/edit', body);
        renderEditResult(data.diff || '', data.editId || data.id || '');
      } catch (err) {
        renderError(err.message);
      }
    }

    function handleRetry() {
      renderEditInput(lastEditInstruction);
    }

    async function captureSelectionScreenshot() {
      // Use canvas to capture the visible area around the selection
      // This is a best-effort feature ‚Äî returns null if not possible
      var sel = window.getSelection();
      if (!sel || sel.rangeCount === 0) return null;
      var range = sel.getRangeAt(0);
      var rect = range.getBoundingClientRect();
      if (!rect || rect.width === 0) return null;

      // Try html2canvas if available, otherwise return null
      if (typeof html2canvas === 'undefined') return null;

      var container = range.commonAncestorContainer;
      var el = container.nodeType === 3 ? container.parentElement : container;
      // Go up to find a reasonable container
      while (el && el.offsetHeight < 50) el = el.parentElement;
      if (!el) return null;

      try {
        var canvas = await html2canvas(el, {
          useCORS: true,
          scale: 1,
          width: Math.min(el.offsetWidth, 800),
          height: Math.min(el.offsetHeight, 600),
        });
        // Convert to base64 PNG (strip the data:image/png;base64, prefix)
        var dataUrl = canvas.toDataURL('image/png');
        return dataUrl.replace(/^data:image\/png;base64,/, '');
      } catch (_err) {
        return null;
      }
    }

    async function handleConfirm() {
      renderLoading();
      try {
        const data = await apiRequest('/ai/edit/confirm', {
          editId: pendingEditId,
        });
        renderCommitted(data.commitHash || data.commit || '');
      } catch (err) {
        renderError(err.message);
      }
    }

    function handleLogin() {
      // Save current page URL so we can return after login
      try {
        localStorage.setItem(RETURN_KEY, window.location.href);
      } catch (_error) {
        // Ignore storage failures (private mode / quota), login can still continue.
      }
      window.location.href = apiUrl + '/auth/github';
    }

    // Event delegation for popup buttons
    document.addEventListener('click', function (e) {
      const btn = e.target.closest('[data-action]');
      if (!btn || !popup || !popup.contains(btn)) return;

      const action = btn.getAttribute('data-action');
      e.stopPropagation();

      switch (action) {
        case 'ask':
          handleAsk();
          break;
        case 'submit-ask':
          handleSubmitAsk();
          break;
        case 'cancel-ask':
          removePopup();
          break;
        case 'edit':
          handleEdit();
          break;
        case 'submit-edit':
          handleSubmitEdit();
          break;
        case 'cancel-edit':
          removePopup();
          break;
        case 'confirm':
        case 'accept':
          handleConfirm();
          break;
        case 'retry':
          handleRetry();
          break;
        case 'reject':
          removePopup();
          break;
        case 'login':
          handleLogin();
          break;
        case 'close':
          removePopup();
          break;
      }
    });

    // Show popup on text selection in post-content
    function onSelectionEnd(_event) {
      // Small delay to let selection finalize
      setTimeout(function () {
        const sel = window.getSelection();
        const text = sel ? sel.toString().trim() : '';

        if (!text || text.length < 2) {
          // Don't remove if popup is showing results
          if (currentState === 'buttons') {
            removePopup();
          }
          return;
        }

        // Check if selection is inside .post-content
        if (!sel.anchorNode || !isInsidePostContent(sel.anchorNode)) {
          return;
        }

        selectedText = text;

        const rect = getSelectionRect();
        if (!rect) return;

        createPopup();
        renderButtons();
        positionPopup(rect);
      }, 10);
    }

    function getEventPoint(e) {
      if (typeof e.clientX === 'number' && typeof e.clientY === 'number') {
        return { x: e.clientX, y: e.clientY };
      }
      if (e.touches && e.touches.length > 0) {
        return { x: e.touches[0].clientX, y: e.touches[0].clientY };
      }
      if (e.changedTouches && e.changedTouches.length > 0) {
        return { x: e.changedTouches[0].clientX, y: e.changedTouches[0].clientY };
      }
      return null;
    }

    function isPointInCurrentSelection(x, y) {
      const sel = window.getSelection();
      if (!sel || sel.rangeCount === 0 || sel.isCollapsed) return false;

      const padding = 8;
      for (let i = 0; i < sel.rangeCount; i++) {
        const range = sel.getRangeAt(i);
        const rects = range.getClientRects();
        for (let j = 0; j < rects.length; j++) {
          const rect = rects[j];
          if (
            x >= rect.left - padding &&
            x <= rect.right + padding &&
            y >= rect.top - padding &&
            y <= rect.bottom + padding
          ) {
            return true;
          }
        }
      }
      return false;
    }

    function onPointerOutsideSelection(e) {
      const target = e.target;
      if (popup && target && popup.contains(target)) return;

      var sel = window.getSelection();
      if (!sel || sel.rangeCount === 0 || sel.isCollapsed) {
        if (currentState === 'buttons') {
          removePopup();
        }
        return;
      }

      var point = getEventPoint(e);
      if (!point) return;

      // Keep selection if user taps inside selected text.
      if (isPointInCurrentSelection(point.x, point.y)) return;

      // iOS Safari can race with native selection updates; defer one frame.
      requestAnimationFrame(function () {
        var currentSel = window.getSelection();
        if (currentSel && currentSel.rangeCount > 0) {
          currentSel.removeAllRanges();
        }

        if (currentState === 'buttons') {
          removePopup();
        }
      });
    }

    document.addEventListener('mouseup', onSelectionEnd);
    document.addEventListener('touchend', onSelectionEnd);

    // Tap outside selected text => clear selection (desktop + mobile/iOS)
    if (window.PointerEvent) {
      document.addEventListener('pointerdown', onPointerOutsideSelection, { passive: true });
    } else {
      document.addEventListener('touchstart', onPointerOutsideSelection, { passive: true });
      document.addEventListener('mousedown', onPointerOutsideSelection, { passive: true });
    }

    // Close on Escape
    document.addEventListener('keydown', function (e) {
      if (e.key === 'Escape' && popup) {
        removePopup();
      }
    });
  })();
</script>

<style is:global>
  /* ‚îÄ‚îÄ‚îÄ AI Popup Base ‚îÄ‚îÄ‚îÄ */
  .ai-popup {
    position: absolute;
    z-index: 9999;
    background: var(--color-surface, #24283b);
    border: 1px solid var(--color-border, #3b4261);
    border-radius: 10px;
    padding: 0.4rem;
    box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
    display: flex;
    gap: 0.25rem;
    animation: ai-popup-fadein 0.15s ease-out;
    max-width: 90vw;
  }

  @keyframes ai-popup-fadein {
    from {
      opacity: 0;
      transform: translateY(4px);
    }
    to {
      opacity: 1;
      transform: translateY(0);
    }
  }

  /* ‚îÄ‚îÄ‚îÄ Desktop ‚îÄ‚îÄ‚îÄ */
  .ai-popup--desktop {
    position: absolute;
  }

  /* ‚îÄ‚îÄ‚îÄ Mobile Bottom Sheet ‚îÄ‚îÄ‚îÄ */
  .ai-popup--mobile {
    position: fixed;
    bottom: 0;
    left: 0;
    right: 0;
    top: auto;
    border-radius: 14px 14px 0 0;
    padding: 0.75rem;
    max-width: 100vw;
    box-shadow: 0 -4px 20px rgba(0, 0, 0, 0.4);
    animation: ai-popup-slideup 0.2s ease-out;
  }

  @keyframes ai-popup-slideup {
    from {
      transform: translateY(100%);
    }
    to {
      transform: translateY(0);
    }
  }

  /* ‚îÄ‚îÄ‚îÄ Buttons ‚îÄ‚îÄ‚îÄ */
  .ai-popup-btn {
    border: none;
    background: transparent;
    color: var(--color-text, #a9b1d6);
    font-size: 0.85rem;
    padding: 0.4rem 0.75rem;
    border-radius: 6px;
    cursor: pointer;
    white-space: nowrap;
    font-family: inherit;
    transition: background 0.15s;
  }

  .ai-popup-btn:hover {
    background: var(--color-surface-hover, #2f3549);
  }

  .ai-popup-btn--login {
    color: var(--color-accent, #7aa2f7);
    font-weight: 500;
  }

  .ai-popup-btn--ask {
    color: var(--color-accent, #7aa2f7);
  }

  .ai-popup-btn--edit {
    color: #9ece6a;
  }

  .ai-popup-btn--confirm {
    color: #9ece6a;
    font-weight: 500;
  }

  .ai-popup-btn--cancel {
    color: var(--color-text-muted, #565f89);
  }

  .ai-popup-btn--retry {
    color: var(--color-accent, #7aa2f7);
  }

  /* ‚îÄ‚îÄ‚îÄ Ask Input ‚îÄ‚îÄ‚îÄ */
  .ai-popup-ask-input-container,
  .ai-popup-edit-input-container {
    padding: 0.5rem;
    min-width: 280px;
    max-width: min(500px, 90vw);
  }

  .ai-popup-question-input,
  .ai-popup-edit-input {
    width: 100%;
    padding: 0.5rem 0.75rem;
    border: 1px solid var(--color-border, #3b4261);
    border-radius: 6px;
    background: var(--color-bg, #1a1b26);
    color: var(--color-text, #a9b1d6);
    font-size: 0.85rem;
    font-family: inherit;
    outline: none;
    box-sizing: border-box;
  }

  .ai-popup-question-input:focus,
  .ai-popup-edit-input:focus {
    border-color: var(--color-accent, #7aa2f7);
    box-shadow: 0 0 0 2px rgba(122, 162, 247, 0.2);
  }

  .ai-popup-question-input::placeholder,
  .ai-popup-edit-input::placeholder {
    color: var(--color-text-muted, #565f89);
    opacity: 0.7;
  }

  /* ‚îÄ‚îÄ‚îÄ Loading ‚îÄ‚îÄ‚îÄ */
  .ai-popup-loading {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    padding: 0.5rem 0.75rem;
    color: var(--color-text-muted, #565f89);
    font-size: 0.85rem;
  }

  .ai-popup-spinner {
    width: 16px;
    height: 16px;
    border: 2px solid var(--color-border, #3b4261);
    border-top-color: var(--color-accent, #7aa2f7);
    border-radius: 50%;
    animation: ai-spin 0.7s linear infinite;
    flex-shrink: 0;
  }

  @keyframes ai-spin {
    to {
      transform: rotate(360deg);
    }
  }

  /* ‚îÄ‚îÄ‚îÄ Result Panel ‚îÄ‚îÄ‚îÄ */
  .ai-popup-result {
    position: relative;
    padding: 0.5rem;
    min-width: 280px;
    max-width: min(500px, 90vw);
    max-height: 60vh;
    overflow-y: auto;
  }

  .ai-popup-close {
    position: absolute;
    top: 0.25rem;
    right: 0.25rem;
    background: transparent;
    border: none;
    color: var(--color-text-muted, #565f89);
    font-size: 1rem;
    cursor: pointer;
    padding: 0.25rem 0.5rem;
    border-radius: 4px;
    line-height: 1;
  }

  .ai-popup-close:hover {
    background: var(--color-surface-hover, #2f3549);
    color: var(--color-text, #a9b1d6);
  }

  .ai-popup-result-body {
    margin-top: 1.5rem;
    font-size: 0.9rem;
    line-height: 1.6;
    color: var(--color-text, #a9b1d6);
    white-space: pre-wrap;
    word-break: break-word;
  }

  .ai-popup-result--error .ai-popup-error-text {
    margin-top: 1.5rem;
    color: #f7768e;
    font-size: 0.85rem;
  }

  /* ‚îÄ‚îÄ‚îÄ Diff Display ‚îÄ‚îÄ‚îÄ */
  .ai-popup-diff {
    margin-top: 1.5rem;
    font-family: var(--font-mono, monospace);
    font-size: 0.8rem;
    line-height: 1.5;
    background: var(--color-bg, #1a1b26);
    border-radius: 6px;
    padding: 0.5rem;
    overflow-x: auto;
    max-height: 40vh;
    overflow-y: auto;
  }

  .ai-popup-diff-line {
    white-space: pre;
    padding: 0 0.5rem;
  }

  .ai-popup-diff-add {
    background: rgba(158, 206, 106, 0.15);
    color: #9ece6a;
  }

  .ai-popup-diff-remove {
    background: rgba(247, 118, 142, 0.15);
    color: #f7768e;
  }

  .ai-popup-actions {
    display: flex;
    gap: 0.5rem;
    margin-top: 0.75rem;
    padding-top: 0.5rem;
    border-top: 1px solid var(--color-border, #3b4261);
  }

  /* ‚îÄ‚îÄ‚îÄ Committed ‚îÄ‚îÄ‚îÄ */
  .ai-popup-committed {
    margin-top: 1.5rem;
    font-size: 0.9rem;
    color: #9ece6a;
  }

  .ai-popup-committed code {
    font-family: var(--font-mono, monospace);
    background: var(--color-bg, #1a1b26);
    padding: 0.15em 0.4em;
    border-radius: 4px;
    font-size: 0.85em;
  }

  .ai-popup-committed-icon {
    font-size: 1.1em;
  }

  /* ‚îÄ‚îÄ‚îÄ Light Theme Overrides ‚îÄ‚îÄ‚îÄ */
  [data-theme='light'] .ai-popup {
    box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
  }

  [data-theme='light'] .ai-popup-btn--edit {
    color: var(--color-badge-sd);
  }

  [data-theme='light'] .ai-popup-btn--confirm {
    color: var(--color-badge-sd);
  }

  [data-theme='light'] .ai-popup-diff-add {
    background: rgba(38, 139, 121, 0.1);
    color: var(--color-badge-sd);
  }

  [data-theme='light'] .ai-popup-diff-remove {
    background: rgba(220, 50, 47, 0.1);
    color: #dc322f;
  }

  [data-theme='light'] .ai-popup-committed {
    color: var(--color-badge-sd);
  }

  [data-theme='light'] .ai-popup-result--error .ai-popup-error-text {
    color: #dc322f;
  }

  /* ‚îÄ‚îÄ‚îÄ Mobile adjustments ‚îÄ‚îÄ‚îÄ */
  @media (max-width: 639px) {
    .ai-popup-result {
      min-width: unset;
      max-width: 100%;
    }
  }
</style>
