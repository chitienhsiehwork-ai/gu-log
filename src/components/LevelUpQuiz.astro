---
/**
 * LevelUpQuiz - Interactive MCQ quiz component for Level-Up tutorials
 *
 * Usage in .mdx:
 *   <LevelUpQuiz
 *     question="什麼是 DNS？"
 *     options={[
 *       { label: "A", text: "一種程式語言" },
 *       { label: "B", text: "網域名稱系統" },
 *       { label: "C", text: "一種資料庫" },
 *     ]}
 *     answer="B"
 *     explanation="DNS (Domain Name System) 是將網域名稱轉換成 IP 位址的系統。"
 *   />
 */

interface Option {
  label: string;
  text: string;
}

interface Props {
  question: string;
  options: Option[];
  answer: string;
  explanation: string;
}

const { question, options, answer, explanation } = Astro.props;

// Generate a unique ID for this quiz instance
const quizId = `quiz-${Math.random().toString(36).slice(2, 9)}`;
---

<div class="levelup-quiz" data-quiz-id={quizId} data-answer={answer}>
  <div class="quiz-header">
    <span class="quiz-icon">❓</span>
    <span class="quiz-label">小測驗</span>
  </div>
  <p class="quiz-question">{question}</p>
  <div class="quiz-options">
    {options.map((opt) => (
      <button
        class="quiz-option"
        data-label={opt.label}
        type="button"
      >
        <span class="option-label">{opt.label}</span>
        <span class="option-text">{opt.text}</span>
      </button>
    ))}
  </div>
  <div class="quiz-result" aria-live="polite">
    <div class="result-correct" hidden>
      <span class="result-icon">✅</span>
      <strong>正確！</strong>
      <p class="result-explanation">{explanation}</p>
    </div>
    <div class="result-wrong" hidden>
      <span class="result-icon">❌</span>
      <strong>不對喔！</strong>
      <p class="result-answer">正確答案是 <strong>{answer}</strong></p>
      <p class="result-explanation">{explanation}</p>
    </div>
  </div>
</div>

<script>
  document.addEventListener('click', (e) => {
    const button = (e.target as HTMLElement).closest('.quiz-option');
    if (!button) return;

    const quiz = button.closest('.levelup-quiz') as HTMLElement;
    if (!quiz || quiz.classList.contains('answered')) return;

    const answer = quiz.dataset.answer;
    const selected = (button as HTMLElement).dataset.label;
    const isCorrect = selected === answer;

    // Mark quiz as answered
    quiz.classList.add('answered');

    // Highlight selected option
    button.classList.add(isCorrect ? 'correct' : 'wrong');

    // If wrong, also highlight the correct answer
    if (!isCorrect) {
      const correctBtn = quiz.querySelector(`.quiz-option[data-label="${answer}"]`);
      correctBtn?.classList.add('correct');
    }

    // Disable all options
    quiz.querySelectorAll('.quiz-option').forEach((btn) => {
      (btn as HTMLButtonElement).disabled = true;
    });

    // Show result
    const resultCorrect = quiz.querySelector('.result-correct') as HTMLElement;
    const resultWrong = quiz.querySelector('.result-wrong') as HTMLElement;

    if (isCorrect) {
      resultCorrect.hidden = false;
    } else {
      resultWrong.hidden = false;
    }
  });
</script>

<style>
  .levelup-quiz {
    border: 2px solid var(--color-border);
    border-radius: 12px;
    padding: 1.25rem;
    margin: 1.5rem 0;
    background: var(--color-surface);
  }

  .quiz-header {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    margin-bottom: 0.75rem;
    font-size: 0.85rem;
    color: var(--color-text-muted);
    text-transform: uppercase;
    letter-spacing: 0.05em;
  }

  .quiz-icon {
    font-size: 1.1rem;
  }

  .quiz-question {
    font-size: 1.05rem;
    font-weight: 600;
    margin-bottom: 1rem;
    color: var(--color-text);
    line-height: 1.5;
  }

  .quiz-options {
    display: flex;
    flex-direction: column;
    gap: 0.5rem;
  }

  .quiz-option {
    display: flex;
    align-items: center;
    gap: 0.75rem;
    padding: 0.75rem 1rem;
    border: 2px solid var(--color-border);
    border-radius: 8px;
    background: transparent;
    color: var(--color-text);
    font-family: inherit;
    font-size: 0.95rem;
    cursor: pointer;
    text-align: left;
    transition: border-color 0.2s, background 0.2s;
    -webkit-tap-highlight-color: transparent;
    min-height: 48px; /* Touch-friendly */
  }

  .quiz-option:hover:not(:disabled) {
    border-color: var(--color-accent);
    background: var(--color-surface-hover);
  }

  .quiz-option:disabled {
    cursor: default;
    opacity: 0.8;
  }

  .option-label {
    display: flex;
    align-items: center;
    justify-content: center;
    width: 2rem;
    height: 2rem;
    border-radius: 50%;
    background: var(--color-surface-hover);
    font-weight: 700;
    font-size: 0.85rem;
    flex-shrink: 0;
    color: var(--color-text);
  }

  .option-text {
    flex: 1;
    line-height: 1.4;
  }

  /* Correct answer */
  .quiz-option.correct {
    border-color: #22c55e;
    background: rgba(34, 197, 94, 0.1);
  }

  .quiz-option.correct .option-label {
    background: #22c55e;
    color: #fff;
  }

  /* Wrong answer */
  .quiz-option.wrong {
    border-color: #ef4444;
    background: rgba(239, 68, 68, 0.1);
  }

  .quiz-option.wrong .option-label {
    background: #ef4444;
    color: #fff;
  }

  /* Result area */
  .quiz-result {
    margin-top: 0.75rem;
  }

  .result-correct,
  .result-wrong {
    padding: 1rem;
    border-radius: 8px;
    margin-top: 0.5rem;
    animation: fadeIn 0.3s ease;
  }

  .result-correct {
    background: rgba(34, 197, 94, 0.08);
    border-left: 3px solid #22c55e;
  }

  .result-wrong {
    background: rgba(239, 68, 68, 0.08);
    border-left: 3px solid #ef4444;
  }

  .result-icon {
    font-size: 1.1rem;
    margin-right: 0.25rem;
  }

  .result-explanation {
    margin-top: 0.5rem;
    color: var(--color-text-muted);
    font-size: 0.9rem;
    line-height: 1.6;
  }

  .result-answer {
    margin-top: 0.25rem;
    font-size: 0.9rem;
  }

  /* Light theme adjustments */
  [data-theme='light'] .quiz-option.correct {
    background: rgba(34, 197, 94, 0.08);
  }

  [data-theme='light'] .quiz-option.wrong {
    background: rgba(239, 68, 68, 0.08);
  }

  @keyframes fadeIn {
    from { opacity: 0; transform: translateY(-4px); }
    to { opacity: 1; transform: translateY(0); }
  }

  /* Mobile touch targets */
  @media (pointer: coarse) {
    .quiz-option {
      padding: 1rem;
      min-height: 52px;
    }
  }
</style>
