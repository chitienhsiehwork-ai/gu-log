---
/**
 * Table of Contents Component (Build-time generated)
 *
 * Receives headings from post.render() and generates TOC at build time:
 * - Mobile: Collapsible TOC at top of article
 * - Desktop (>1280px): Sticky sidebar TOC
 * - Highlights current section on scroll (client JS)
 * - Only shows if 2+ headings exist
 */

interface Heading {
  depth: number;
  slug: string;
  text: string;
}

interface Props {
  lang?: 'zh-tw' | 'en';
  headings?: Heading[];
}

const { lang = 'zh-tw', headings = [] } = Astro.props;

// Filter to only h2 and h3
const tocHeadings = headings.filter(h => h.depth === 2 || h.depth === 3);

// Only show TOC if 2+ headings
const showToc = tocHeadings.length >= 2;

const labels = {
  'zh-tw': {
    title: '目錄',
  },
  'en': {
    title: 'Table of Contents',
  }
};

const t = labels[lang];
---

{showToc && (
  <aside class="toc-container" aria-label={t.title}>
    <!-- Mobile Toggle Version -->
    <div class="toc-mobile">
      <div class="toc-toggle-container" data-open="false">
        <button class="toc-toggle-header" aria-expanded="false">
          <span class="toc-toggle-icon"></span>
          <span class="toc-toggle-title">{t.title}</span>
        </button>
        <div class="toc-toggle-wrapper">
          <div class="toc-toggle-inner">
            <nav class="toc-content">
              {tocHeadings.map((heading) => (
                <a 
                  href={`#${heading.slug}`}
                  class={`toc-link toc-link-h${heading.depth}`}
                  data-heading-id={heading.slug}
                >
                  {heading.text}
                </a>
              ))}
            </nav>
          </div>
        </div>
      </div>
    </div>

    <!-- Desktop Sidebar Version -->
    <div class="toc-desktop">
      <nav class="toc-sidebar">
        <h2 class="toc-title">{t.title}</h2>
        <div class="toc-content">
          {tocHeadings.map((heading) => (
            <a 
              href={`#${heading.slug}`}
              class={`toc-link toc-link-h${heading.depth}`}
              data-heading-id={heading.slug}
            >
              {heading.text}
            </a>
          ))}
        </div>
      </nav>
    </div>
  </aside>
)}

<script>
  function initTableOfContents() {
    const tocContainer = document.querySelector('.toc-container');
    if (!tocContainer) return;

    // Get all heading IDs from TOC links
    const tocLinks = Array.from(document.querySelectorAll('.toc-link'));
    const headingIds = tocLinks.map(link => link.getAttribute('data-heading-id')).filter(Boolean);
    const headings = headingIds.map(id => document.getElementById(id!)).filter(Boolean) as HTMLElement[];

    if (headings.length === 0) return;

    // Set up scroll highlighting
    setupScrollHighlight(headings);

    // Set up smooth scrolling
    setupSmoothScroll();
    
    // Note: Mobile toggle is handled by Toggle component's event delegation
  }

  function setupScrollHighlight(headings: HTMLElement[]) {
    let ticking = false;

    function updateActiveHeading() {
      const scrollPos = window.scrollY + 100;

      let currentHeading = headings[0];
      for (const heading of headings) {
        const offsetTop = heading.getBoundingClientRect().top + window.scrollY;
        if (offsetTop <= scrollPos) {
          currentHeading = heading;
        } else {
          break;
        }
      }

      document.querySelectorAll('.toc-link').forEach(link => {
        link.classList.remove('active');
      });

      if (currentHeading?.id) {
        document.querySelectorAll(`[data-heading-id="${currentHeading.id}"]`).forEach(link => {
          link.classList.add('active');
        });
      }

      ticking = false;
    }

    function onScroll() {
      if (!ticking) {
        requestAnimationFrame(updateActiveHeading);
        ticking = true;
      }
    }

    window.addEventListener('scroll', onScroll, { passive: true });
    updateActiveHeading();
  }

  function setupSmoothScroll() {
    const SCROLL_OFFSET = 80; // px offset from top to account for reading progress bar etc.

    document.querySelectorAll('.toc-link').forEach(link => {
      link.addEventListener('click', (e) => {
        e.preventDefault();
        const href = (e.currentTarget as HTMLElement)?.getAttribute('href');
        if (!href) return;

        const targetId = href.replace('#', '');
        const target = document.getElementById(targetId);
        
        if (target) {
          // Calculate exact position instead of scrollIntoView + delayed scrollBy
          // This avoids iOS Safari smooth scroll timing issues
          const targetTop = target.getBoundingClientRect().top + window.scrollY - SCROLL_OFFSET;
          window.scrollTo({ top: targetTop, behavior: 'smooth' });
          history.pushState(null, '', href);

          // Close mobile toggle
          const mobileContainer = document.querySelector('.toc-mobile .toc-toggle-container');
          if (window.innerWidth < 1280 && mobileContainer) {
            mobileContainer.setAttribute('data-open', 'false');
            mobileContainer.querySelector('.toc-toggle-header')?.setAttribute('aria-expanded', 'false');
          }
        }
      });
    });
  }

  function setupMobileToggle() {
    // Handle TOC mobile toggle click with dedicated class names (avoid Toggle component conflict)
    const tocMobile = document.querySelector('.toc-mobile');
    if (!tocMobile) return;

    const toggleHeader = tocMobile.querySelector('.toc-toggle-header');
    const container = tocMobile.querySelector('.toc-toggle-container');
    
    if (!toggleHeader || !container) return;

    toggleHeader.addEventListener('click', () => {
      const isOpen = container.getAttribute('data-open') === 'true';
      container.setAttribute('data-open', (!isOpen).toString());
      toggleHeader.setAttribute('aria-expanded', (!isOpen).toString());
    });
  }

  // Initialize
  initTableOfContents();
  setupMobileToggle();
  document.addEventListener('astro:page-load', () => {
    initTableOfContents();
    setupMobileToggle();
  });
</script>

<style>
  .toc-container {
    margin: 1.5rem 0;
  }

  .toc-mobile {
    display: block;
  }

  .toc-desktop {
    display: none;
  }

  .toc-toggle-container {
    border-radius: 8px;
    background: var(--color-surface);
    overflow: hidden;
  }

  .toc-toggle-header {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    padding: 0.75rem 1rem;
    width: 100%;
    background: none;
    border: none;
    color: inherit;
    font-family: inherit;
    font-size: inherit;
    cursor: pointer;
    text-align: left;
    outline: none;
    -webkit-tap-highlight-color: transparent;
  }

  .toc-toggle-icon {
    width: 0;
    height: 0;
    border-left: 6px solid var(--color-text);
    border-top: 5px solid transparent;
    border-bottom: 5px solid transparent;
    transition: transform 0.3s ease;
    flex-shrink: 0;
  }

  .toc-toggle-container[data-open="true"] .toc-toggle-icon {
    transform: rotate(90deg);
  }

  .toc-toggle-title {
    flex: 1;
    font-weight: 600;
    font-size: 0.95rem;
  }

  .toc-toggle-wrapper {
    display: grid;
    grid-template-rows: 0fr;
    transition: grid-template-rows 0.3s cubic-bezier(0.4, 0, 0.2, 1);
  }

  .toc-toggle-container[data-open="true"] .toc-toggle-wrapper {
    grid-template-rows: 1fr;
  }

  .toc-toggle-inner {
    overflow: hidden;
  }

  .toc-content {
    display: flex;
    flex-direction: column;
    gap: 0.3rem;
  }

  .toc-mobile .toc-content {
    padding: 0.5rem 1rem 1rem 1.75rem;
  }

  .toc-link {
    color: var(--color-text-muted);
    text-decoration: none;
    font-size: 0.9rem;
    line-height: 1.5;
    transition: color 0.2s ease;
    padding: 0.2rem 0;
  }

  .toc-link:hover {
    color: var(--color-accent);
  }

  .toc-link.active {
    color: var(--color-accent);
    font-weight: 500;
  }

  .toc-link-h3 {
    padding-left: 1rem;
    font-size: 0.85rem;
  }

  @media (min-width: 1280px) {
    .toc-mobile {
      display: none;
    }

    .toc-desktop {
      display: block;
      position: fixed;
      right: max(1rem, calc((100vw - 680px) / 2 - 220px));
      top: 6rem;
      width: 200px;
      max-height: calc(100vh - 8rem);
      overflow-y: auto;
    }

    .toc-sidebar {
      padding: 1rem;
      background: var(--color-surface);
      border-radius: 8px;
      border: 1px solid var(--color-border);
    }

    .toc-title {
      font-size: 0.95rem;
      font-weight: 600;
      margin-bottom: 0.75rem;
      color: var(--color-text);
    }

    .toc-desktop .toc-content {
      padding: 0;
    }

    .toc-desktop::-webkit-scrollbar {
      width: 4px;
    }

    .toc-desktop::-webkit-scrollbar-track {
      background: transparent;
    }

    .toc-desktop::-webkit-scrollbar-thumb {
      background: var(--color-border);
      border-radius: 4px;
    }
  }

  @media (min-width: 1400px) {
    .toc-desktop {
      right: max(2rem, calc((100vw - 680px) / 2 - 260px));
      width: 240px;
    }
  }

  @media (pointer: coarse) {
    .toc-toggle-header {
      padding: 1rem;
      min-height: 48px;
    }

    .toc-link {
      padding: 0.4rem 0;
      min-height: 44px;
      display: flex;
      align-items: center;
    }
  }
</style>
