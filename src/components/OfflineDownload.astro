---
// Offline Download Button â€” caches all article pages for offline reading
interface Props {
  lang?: 'zh-tw' | 'en';
}
const { lang = 'zh-tw' } = Astro.props;
const label = lang === 'zh-tw' ? 'ğŸ“¥ ä¸‹è¼‰é›¢ç·šç‰ˆ' : 'ğŸ“¥ Download Offline';
const labelCaching = lang === 'zh-tw' ? 'å¿«å–ä¸­...' : 'Caching...';
const labelDone = lang === 'zh-tw' ? 'âœ… é›¢ç·šç‰ˆå·²å°±ç·’' : 'âœ… Ready for Offline';
const labelError = lang === 'zh-tw' ? 'âŒ å¿«å–å¤±æ•—' : 'âŒ Cache Failed';
---

<div class="offline-download-wrapper">
  <button
    class="offline-download-btn"
    id="offline-download-btn"
    data-label={label}
    data-label-caching={labelCaching}
    data-label-done={labelDone}
    data-label-error={labelError}
  >
    {label}
  </button>
  <div class="offline-progress" id="offline-progress">
    <div class="offline-progress-bar" id="offline-progress-bar"></div>
  </div>
  <p class="offline-status" id="offline-status"></p>
</div>

<script is:inline>
(function() {
  const btn = document.getElementById('offline-download-btn');
  const progress = document.getElementById('offline-progress');
  const progressBar = document.getElementById('offline-progress-bar');
  const status = document.getElementById('offline-status');
  if (!btn || !('serviceWorker' in navigator)) {
    if (btn) btn.style.display = 'none';
    return;
  }

  // Check if already cached
  async function checkCacheStatus() {
    try {
      const cache = await caches.open('pages-cache');
      const keys = await cache.keys();
      if (keys.length > 20) {
        btn.textContent = btn.dataset.labelDone;
        btn.classList.add('done');
        status.textContent = keys.length + (btn.dataset.label.includes('é›¢ç·š') ? ' é å·²å¿«å–' : ' pages cached');
      }
    } catch(_e) { /* ignore */ }
  }
  checkCacheStatus();

  btn.addEventListener('click', async function() {
    if (btn.classList.contains('done') || btn.classList.contains('caching')) return;
    btn.classList.add('caching');
    btn.textContent = btn.dataset.labelCaching;
    progress.style.display = 'block';

    try {
      // Fetch the search index to get all article URLs
      const res = await fetch('/search-index.json');
      const articles = await res.json();
      const urls = articles.map(function(a) { return a.url; });

      // Also add listing pages
      const allUrls = ['/', '/en/', '/clawd-picks/', '/en/clawd-picks/',
                     '/shroomdog-picks/', '/level-up/', '/about/', '/en/about/'];
      for (let i = 0; i < urls.length; i++) { allUrls.push(urls[i]); }

      const total = allUrls.length;
      let done = 0;
      let failed = 0;
      const concurrency = 6;
      const queue = allUrls.slice();
      const cache = await caches.open('pages-cache');

      async function worker() {
        while (queue.length > 0) {
          const url = queue.shift();
          try {
            const resp = await fetch(url);
            if (resp.ok) {
              await cache.put(url, resp);
            } else {
              failed++;
            }
            done++;
          } catch(_e) {
            failed++;
            done++;
          }
          const pct = Math.round((done / total) * 100);
          progressBar.style.width = pct + '%';
          status.textContent = done + '/' + total + (failed > 0 ? ' (' + failed + ' failed)' : '');
        }
      }

      const workers = [];
      for (let w = 0; w < concurrency; w++) { workers.push(worker()); }
      await Promise.all(workers);

      btn.textContent = btn.dataset.labelDone;
      btn.classList.remove('caching');
      btn.classList.add('done');
      status.textContent = (total - failed) + (btn.dataset.label.includes('é›¢ç·š') ? ' é å·²å¿«å– âœˆï¸' : ' pages cached âœˆï¸');
    } catch(err) {
      btn.textContent = btn.dataset.labelError;
      btn.classList.remove('caching');
      status.textContent = err.message;
    }
  });
})();
</script>

<style>
  .offline-download-wrapper {
    text-align: center;
    margin: 1.5rem 0 0.5rem;
  }

  .offline-download-btn {
    display: inline-block;
    padding: 0.6rem 1.2rem;
    border: 1.5px solid var(--color-border, #444);
    border-radius: 8px;
    background: var(--color-surface, #1e1e2e);
    color: var(--color-text, #ccc);
    font-size: 0.9rem;
    font-weight: 500;
    cursor: pointer;
    transition: all 0.2s ease;
  }

  .offline-download-btn:hover:not(.done):not(.caching) {
    border-color: var(--color-accent, #e67e22);
    color: var(--color-accent, #e67e22);
  }

  .offline-download-btn.caching {
    opacity: 0.7;
    cursor: wait;
  }

  .offline-download-btn.done {
    border-color: #27ae60;
    color: #27ae60;
    cursor: default;
  }

  .offline-progress {
    display: none;
    margin: 0.75rem auto;
    max-width: 300px;
    height: 4px;
    background: var(--color-border, #333);
    border-radius: 2px;
    overflow: hidden;
  }

  .offline-progress-bar {
    width: 0%;
    height: 100%;
    background: var(--color-accent, #e67e22);
    transition: width 0.15s ease;
    border-radius: 2px;
  }

  .offline-status {
    font-size: 0.8rem;
    color: var(--color-text-muted, #888);
    margin: 0.25rem 0 0;
  }
</style>
