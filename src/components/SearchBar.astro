---
import { searchConfig } from '../config/search';

interface Props {
  lang: 'zh-tw' | 'en';
}

const { lang } = Astro.props;

const i18n = {
  'zh-tw': {
    placeholder: '搜尋文章（可用 SD-1, SP-14...）',
    noResults: '找不到結果',
    shortcut: '⌘K',
  },
  'en': {
    placeholder: 'Search (e.g., SD-1, SP-14...)',
    noResults: 'No results found',
    shortcut: '⌘K',
  }
};

const t = i18n[lang];
---

<!-- Search trigger stays in header -->
<button class="search-trigger" aria-label="Toggle search" title={t.shortcut} data-search-trigger>
  <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
    <circle cx="11" cy="11" r="8"></circle>
    <line x1="21" y1="21" x2="16.65" y2="16.65"></line>
  </svg>
</button>

<!-- Modal rendered at body level via portal -->
<div class="search-modal-overlay" data-search-modal data-lang={lang} aria-hidden="true">
  <div class="search-modal">
    <div class="search-modal-header">
      <svg class="search-modal-icon" xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
        <circle cx="11" cy="11" r="8"></circle>
        <line x1="21" y1="21" x2="16.65" y2="16.65"></line>
      </svg>
      <input
        type="text"
        class="search-modal-input"
        placeholder={t.placeholder}
        autocomplete="off"
        spellcheck="false"
        data-search-input
      />
      <kbd class="search-shortcut">ESC</kbd>
    </div>
    <div class="search-results" role="listbox" aria-label="Search results" data-search-results>
      <!-- JS populated -->
    </div>
  </div>
</div>

<script define:vars={{ 
  noResultsText: t.noResults, 
  currentLang: lang,
  maxResults: searchConfig.maxResults,
  debounceMs: searchConfig.debounceMs,
  enableTicketSearch: searchConfig.enableTicketSearch
}}>
  // Search state
  let searchIndex = null;
  let debounceTimer = null;
  let selectedIndex = -1;

  const trigger = document.querySelector('[data-search-trigger]');
  const modal = document.querySelector('[data-search-modal]');
  const input = modal?.querySelector('[data-search-input]');
  const results = modal?.querySelector('[data-search-results]');

  // Fetch search index on first open
  async function loadSearchIndex() {
    if (searchIndex) return;
    try {
      const res = await fetch('/search-index.json');
      searchIndex = await res.json();
    } catch (e) {
      console.error('Failed to load search index:', e);
    }
  }

  // Open search modal
  function openSearch() {
    modal?.setAttribute('aria-hidden', 'false');
    document.body.style.overflow = 'hidden';
    loadSearchIndex();
    setTimeout(() => input?.focus(), 50);
  }

  // Close search modal
  function closeSearch() {
    modal?.setAttribute('aria-hidden', 'true');
    document.body.style.overflow = '';
    if (input) input.value = '';
    if (results) results.innerHTML = '';
    selectedIndex = -1;
  }

  // Toggle search
  function toggleSearch() {
    const isHidden = modal?.getAttribute('aria-hidden') === 'true';
    if (isHidden) {
      openSearch();
    } else {
      closeSearch();
    }
  }

  // Search and display results
  function performSearch(query) {
    if (!searchIndex || !results) return;

    const trimmed = query.trim().toLowerCase();
    if (!trimmed) {
      results.innerHTML = '';
      selectedIndex = -1;
      return;
    }

    // Filter by current language and search query
    const filtered = searchIndex
      .filter(post => post.lang === currentLang)
      .filter(post => {
        // Check ticket ID first (exact match, case insensitive)
        if (enableTicketSearch && post.ticketId) {
          if (post.ticketId.toLowerCase() === trimmed) {
            return true;
          }
          // Also match partial ticket ID (e.g., "SD" matches "SD-1")
          if (post.ticketId.toLowerCase().startsWith(trimmed)) {
            return true;
          }
        }
        
        // Then check title, summary, source, tags
        const searchable = [
          post.ticketId || '',
          post.title,
          post.summary,
          post.source,
          ...(post.tags || [])
        ].join(' ').toLowerCase();
        return searchable.includes(trimmed);
      })
      .slice(0, maxResults);

    if (filtered.length === 0) {
      results.innerHTML = `<div class="search-no-results">${noResultsText}</div>`;
      selectedIndex = -1;
      return;
    }

    // Render results with proper formatting
    const baseUrl = currentLang === 'en' ? '/en/posts/' : '/posts/';
    results.innerHTML = filtered.map((post, index) => {
      // Remove 'en-' prefix from slug for en posts
      const displaySlug = post.lang === 'en' && post.slug.startsWith('en-')
        ? post.slug.slice(3)
        : post.slug;
      
      const ticketBadge = post.ticketId 
        ? `<span class="search-result-ticket">${escapeHtml(post.ticketId)}</span>` 
        : '';
      
      return `
        <a href="${baseUrl}${displaySlug}"
           class="search-result-item"
           role="option"
           data-index="${index}">
          <div class="search-result-header">
            ${ticketBadge}
            <span class="search-result-date">${post.date}</span>
          </div>
          <div class="search-result-title">${escapeHtml(post.title)}</div>
          <div class="search-result-source">${escapeHtml(post.source)}</div>
        </a>
      `;
    }).join('');

    selectedIndex = -1;
  }

  // Escape HTML to prevent XSS
  function escapeHtml(text) {
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
  }

  // Update selection highlight
  function updateSelection() {
    const items = results?.querySelectorAll('.search-result-item');
    items?.forEach((item, i) => {
      item.classList.toggle('selected', i === selectedIndex);
    });
  }

  // Navigate to selected result
  function navigateToSelected() {
    const items = results?.querySelectorAll('.search-result-item');
    if (items && selectedIndex >= 0 && selectedIndex < items.length) {
      const href = items[selectedIndex].getAttribute('href');
      if (href) window.location.href = href;
    }
  }

  // Event listeners
  trigger?.addEventListener('click', (e) => {
    e.preventDefault();
    openSearch();
  });

  // Close on overlay click
  modal?.addEventListener('click', (e) => {
    if (e.target === modal) {
      closeSearch();
    }
  });

  input?.addEventListener('input', (e) => {
    clearTimeout(debounceTimer);
    debounceTimer = setTimeout(() => {
      performSearch(e.target.value);
    }, debounceMs);
  });

  input?.addEventListener('keydown', (e) => {
    const items = results?.querySelectorAll('.search-result-item');
    const itemCount = items?.length || 0;

    switch (e.key) {
      case 'Escape':
        e.preventDefault();
        closeSearch();
        trigger?.focus();
        break;
      case 'ArrowDown':
        e.preventDefault();
        if (itemCount > 0) {
          selectedIndex = (selectedIndex + 1) % itemCount;
          updateSelection();
        }
        break;
      case 'ArrowUp':
        e.preventDefault();
        if (itemCount > 0) {
          selectedIndex = selectedIndex <= 0 ? itemCount - 1 : selectedIndex - 1;
          updateSelection();
        }
        break;
      case 'Enter':
        e.preventDefault();
        if (selectedIndex >= 0) {
          navigateToSelected();
        }
        break;
    }
  });

  // Global Cmd/Ctrl+K shortcut
  document.addEventListener('keydown', (e) => {
    if ((e.metaKey || e.ctrlKey) && e.key === 'k') {
      e.preventDefault();
      toggleSearch();
    }
  });
</script>

<style is:global>
  /* Trigger button in header */
  .search-trigger {
    background: transparent;
    border: none;
    padding: 0.25rem;
    cursor: pointer;
    line-height: 1;
    transition: color 0.2s ease, opacity 0.2s ease;
    display: flex;
    align-items: center;
    justify-content: center;
    color: var(--color-text-muted);
    outline: none;
    -webkit-tap-highlight-color: transparent;
  }

  .search-trigger:hover {
    color: var(--color-text);
  }

  .search-trigger:focus {
    outline: none;
  }

  .search-trigger:active {
    opacity: 0.7;
  }

  @media (pointer: coarse) {
    .search-trigger {
      min-width: 32px;
      min-height: 32px;
    }
  }

  /* Modal overlay */
  .search-modal-overlay {
    position: fixed;
    inset: 0;
    background: rgba(0, 0, 0, 0.5);
    backdrop-filter: blur(4px);
    z-index: 1000;
    display: flex;
    align-items: flex-start;
    justify-content: center;
    padding-top: 12vh;
    opacity: 0;
    visibility: hidden;
    transition: opacity 0.2s ease, visibility 0.2s ease;
  }

  .search-modal-overlay[aria-hidden="false"] {
    opacity: 1;
    visibility: visible;
  }

  /* Modal container */
  .search-modal {
    width: 90%;
    max-width: 480px;
    background: var(--color-bg);
    border: 1px solid var(--color-border);
    border-radius: 12px;
    box-shadow: 0 16px 48px rgba(0, 0, 0, 0.25);
    overflow: hidden;
    transform: scale(0.95) translateY(-10px);
    transition: transform 0.2s ease;
  }

  .search-modal-overlay[aria-hidden="false"] .search-modal {
    transform: scale(1) translateY(0);
  }

  /* Modal header with input */
  .search-modal-header {
    display: flex;
    align-items: center;
    gap: 0.75rem;
    padding: 1rem 1.25rem;
    border-bottom: 1px solid var(--color-border);
  }

  .search-modal-icon {
    color: var(--color-text-muted);
    flex-shrink: 0;
  }

  .search-modal-input {
    flex: 1;
    border: none;
    background: transparent;
    color: var(--color-text);
    font-size: 1rem;
    outline: none;
  }

  .search-modal-input::placeholder {
    color: var(--color-text-muted);
  }

  .search-shortcut {
    font-size: 0.7rem;
    padding: 0.2rem 0.4rem;
    background: var(--color-bg-muted);
    border: 1px solid var(--color-border);
    border-radius: 4px;
    color: var(--color-text-muted);
    flex-shrink: 0;
  }

  /* Search results */
  .search-results {
    max-height: 360px;
    overflow-y: auto;
  }

  .search-results:empty {
    display: none;
  }

  /* Individual result item — card-like with clear separation */
  .search-result-item {
    display: block;
    padding: 0.875rem 1.25rem;
    margin: 6px 8px;
    text-decoration: none;
    border: 1px solid var(--color-border, #e0e0e0);
    border-radius: 8px;
    transition: background 0.15s ease, border-color 0.15s ease;
  }

  .search-result-item:first-child {
    margin-top: 8px;
  }

  .search-result-item:last-child {
    margin-bottom: 8px;
  }

  .search-result-item:hover,
  .search-result-item.selected {
    background: var(--color-bg-muted);
    border-color: var(--color-accent);
  }

  /* Result header with ticket ID and date */
  .search-result-header {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    margin-bottom: 0.375rem;
  }

  .search-result-ticket {
    display: inline-block;
    padding: 0.125rem 0.5rem;
    background: var(--color-accent);
    color: white;
    font-size: 0.7rem;
    font-weight: 600;
    border-radius: 4px;
    font-family: 'SF Mono', 'Monaco', 'Consolas', monospace;
  }

  .search-result-date {
    color: var(--color-text-muted);
    font-size: 0.7rem;
  }

  /* Result title */
  .search-result-title {
    color: var(--color-text);
    font-size: 0.95rem;
    font-weight: 600;
    margin-bottom: 0.3rem;
    line-height: 1.4;
    /* Allow 2 lines */
    display: -webkit-box;
    -webkit-line-clamp: 2;
    -webkit-box-orient: vertical;
    overflow: hidden;
  }

  /* Result source */
  .search-result-source {
    color: var(--color-text-muted);
    font-size: 0.72rem;
  }

  .search-no-results {
    padding: 1.5rem;
    text-align: center;
    color: var(--color-text-muted);
    font-size: 0.9rem;
  }
</style>
