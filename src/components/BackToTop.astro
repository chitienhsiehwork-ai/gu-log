---
/**
 * Back to Top Button Component
 *
 * Floating button that appears after scrolling 300px+ down.
 * Smooth scrolls to top on click.
 * Styled to be subtle and match Solarized theme.
 */

interface Props {
  lang?: 'zh-tw' | 'en';
}

const { lang = 'zh-tw' } = Astro.props;

const labels = {
  'zh-tw': {
    ariaLabel: '返回頂部',
    title: '返回頂部',
  },
  en: {
    ariaLabel: 'Back to top',
    title: 'Back to top',
  },
};

const t = labels[lang];
---

<button id="back-to-top" class="back-to-top" aria-label={t.ariaLabel} title={t.title} type="button">
  <svg
    width="24"
    height="24"
    viewBox="0 0 24 24"
    fill="none"
    stroke="currentColor"
    stroke-width="2"
    stroke-linecap="round"
    stroke-linejoin="round"
    aria-hidden="true"
  >
    <polyline points="18 15 12 9 6 15"></polyline>
  </svg>
</button>

<script>
  function initBackToTop() {
    const button = document.getElementById('back-to-top');
    if (!button) return;

    let ticking = false;
    const threshold = 300; // Show button after scrolling 300px

    // Check if page is tall enough to need back-to-top button
    function shouldShowButton(): boolean {
      const docHeight = document.documentElement.scrollHeight;
      const viewportHeight = window.innerHeight;
      return docHeight > viewportHeight + 400; // Only show if page is significantly tall
    }

    // Update button visibility based on scroll position
    function updateButtonVisibility() {
      if (!button) return;

      const scrollTop = window.scrollY || document.documentElement.scrollTop;

      if (shouldShowButton() && scrollTop > threshold) {
        button.classList.add('visible');
      } else {
        button.classList.remove('visible');
      }

      ticking = false;
    }

    // Throttle scroll events with RAF
    function onScroll() {
      if (!ticking) {
        requestAnimationFrame(updateButtonVisibility);
        ticking = true;
      }
    }

    // Smooth scroll to top
    function scrollToTop(e: Event) {
      e.preventDefault();
      window.scrollTo({
        top: 0,
        behavior: 'smooth',
      });
    }

    // Initialize visibility on load
    updateButtonVisibility();

    // Listen to scroll and click events
    window.addEventListener('scroll', onScroll, { passive: true });
    button.addEventListener('click', scrollToTop);

    // Re-check on resize (page height might change)
    window.addEventListener(
      'resize',
      () => {
        updateButtonVisibility();
      },
      { passive: true }
    );
  }

  // Initialize on page load
  initBackToTop();

  // Re-initialize on view transitions (Astro)
  document.addEventListener('astro:page-load', initBackToTop);
</script>

<style>
  .back-to-top {
    position: fixed !important;
    bottom: 1.5rem !important;
    right: 1.5rem !important;
    width: 48px;
    height: 48px;
    border-radius: 50%;
    background: var(--color-surface);
    border: 1px solid var(--color-border);
    color: var(--color-text);
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    opacity: 0;
    visibility: hidden;
    transform: translateY(10px) translateZ(0); /* translateZ(0) forces GPU layer for Safari */
    -webkit-transform: translateY(10px) translateZ(0);
    transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    z-index: 9999;
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
    -webkit-tap-highlight-color: transparent;
    -webkit-backface-visibility: hidden; /* Safari fixed positioning fix */
    backface-visibility: hidden;
  }

  .back-to-top.visible {
    opacity: 0.7;
    visibility: visible;
    transform: translateY(0) translateZ(0);
    -webkit-transform: translateY(0) translateZ(0);
  }

  .back-to-top:hover {
    opacity: 1;
    transform: translateY(-2px) translateZ(0);
    -webkit-transform: translateY(-2px) translateZ(0);
    box-shadow: 0 6px 16px rgba(0, 0, 0, 0.2);
    border-color: var(--color-accent);
  }

  .back-to-top:active {
    transform: translateY(0) translateZ(0);
    -webkit-transform: translateY(0) translateZ(0);
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.15);
  }

  .back-to-top:focus-visible {
    outline: 2px solid var(--color-accent);
    outline-offset: 2px;
    opacity: 1;
  }

  .back-to-top svg {
    flex-shrink: 0;
  }

  /* Mobile adjustments */
  @media (max-width: 640px) {
    .back-to-top {
      bottom: 1.5rem;
      right: 1.5rem;
      width: 44px;
      height: 44px;
    }
  }

  /* Touch-friendly sizing */
  @media (pointer: coarse) {
    .back-to-top {
      width: 52px;
      height: 52px;
    }
  }

  /* Respect reduced motion preference */
  @media (prefers-reduced-motion: reduce) {
    .back-to-top {
      transition:
        opacity 0.2s,
        visibility 0.2s;
    }
  }

  /* Theme-specific adjustments */
  [data-theme='light'] .back-to-top {
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
  }

  [data-theme='light'] .back-to-top:hover {
    box-shadow: 0 6px 16px rgba(0, 0, 0, 0.12);
  }

  [data-theme='dark'] .back-to-top {
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
  }

  [data-theme='dark'] .back-to-top:hover {
    box-shadow: 0 6px 16px rgba(0, 0, 0, 0.4);
  }
</style>
