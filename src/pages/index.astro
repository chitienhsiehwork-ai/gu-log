---
import { getCollection } from 'astro:content';
import BaseLayout from '../layouts/BaseLayout.astro';
import Toggle from '../components/Toggle.astro';
import TicketBadge from '../components/TicketBadge.astro';

// Get all zh-tw posts
const allPosts = await getCollection('posts', ({ data }) => {
  return data.lang === 'zh-tw';
});

// Helper: extract number from ticketId (e.g., "CP-11" â†’ 11)
const getTicketNumber = (ticketId: string | undefined) => {
  if (!ticketId) return 0;
  const match = ticketId.match(/\d+$/);
  return match ? parseInt(match[0]) : 0;
};

// Sort by ticketId number descending (largest first = newest)
const sortByTicketNumber = (a: any, b: any) =>
  getTicketNumber(b.data.ticketId) - getTicketNumber(a.data.ticketId);

// Filter and sort each category
const sdPosts = allPosts
  .filter(p => p.data.ticketId?.startsWith('SD-'))
  .sort(sortByTicketNumber);

const spPosts = allPosts
  .filter(p => p.data.ticketId?.startsWith('SP-'))
  .sort(sortByTicketNumber);

const cpPosts = allPosts
  .filter(p => p.data.ticketId?.startsWith('CP-'))
  .sort(sortByTicketNumber);
---

<BaseLayout title="ShroomDog">
  <h1><img src="/avatar.jpg" alt="é¦™è‡å¤§ç‹—ç‹—" class="site-avatar" /> é¦™è‡å¤§ç‹—ç‹—</h1>
  <p class="intro">
    ç²¾é¸å¤–æ–‡å¥½æ–‡ï¼Œç¿»è­¯æˆç¹é«”ä¸­æ–‡ã€‚æ¯ç¯‡éƒ½é™„åŸæ–‡é€£çµã€‚
  </p>
  <p class="author-note">
    by ShroomDog and Clawd
  </p>

  {/* SD: ShroomDog Original - ç½®é ‚ */}
  {sdPosts.length > 0 && (
    <section class="posts-section sd-section">
      <h2>ğŸ„ ShroomDog Original</h2>
      <p class="section-subtitle">ShroomDog åŸå‰µå…§å®¹</p>

      {sdPosts.slice(0, 3).map((post) => (
        <article class="post-preview">
          <h3><a href={`/posts/${post.slug}`}>{post.data.title}</a></h3>
          <p class="post-meta">
            {post.data.ticketId && <TicketBadge ticketId={post.data.ticketId} />}
            {post.data.date} Â· {post.data.source}
          </p>
          <Toggle title="æ‘˜è¦é è¦½">
            <p>{post.data.summary}</p>
          </Toggle>
        </article>
      ))}

      {sdPosts.length > 3 && (
        <p class="view-all"><a href="/shroomdog-originals">æŸ¥çœ‹å…¨éƒ¨ â†’</a></p>
      )}
    </section>
  )}

  {/* SP: ShroomDog Picks */}
  {spPosts.length > 0 && (
    <section class="posts-section sp-section">
      <h2>ğŸ“š ShroomDog Picks</h2>
      <p class="section-subtitle">ShroomDog ç²¾é¸é•·æ–‡ç¿»è­¯</p>

      {spPosts.slice(0, 3).map((post) => (
        <article class="post-preview">
          <h3><a href={`/posts/${post.slug}`}>{post.data.title}</a></h3>
          <p class="post-meta">
            {post.data.ticketId && <TicketBadge ticketId={post.data.ticketId} />}
            {post.data.date} Â· ç¿»è­¯è‡ª {post.data.source}
          </p>
          <Toggle title="æ‘˜è¦é è¦½">
            <p>{post.data.summary}</p>
          </Toggle>
        </article>
      ))}

      {spPosts.length > 3 && (
        <p class="view-all"><a href="/shroomdog-picks">æŸ¥çœ‹å…¨éƒ¨ â†’</a></p>
      )}
    </section>
  )}

  {/* CP: Clawd Picks */}
  {cpPosts.length > 0 && (
    <section class="clawd-picks-section" id="clawd-picks">
      <h2><img src="/clawd-icon.png" alt="" class="clawd-section-icon" /> Clawd Picks</h2>
      <p class="section-subtitle">Clawd æ¯å°æ™‚ç²¾é¸ä¸€å‰‡æ¨æ–‡ç¿»è­¯</p>

      {cpPosts.slice(0, 3).map((pick) => (
        <article class="pick-preview">
          <a href={`/posts/${pick.slug}`}>{pick.data.title}</a>
          <span class="pick-meta">
            {pick.data.ticketId && <TicketBadge ticketId={pick.data.ticketId} />}
            {pick.data.date} Â· {pick.data.source}
          </span>
        </article>
      ))}

      {cpPosts.length > 3 && (
        <p class="view-all"><a href="/clawd-picks">æŸ¥çœ‹å…¨éƒ¨ â†’</a></p>
      )}
    </section>
  )}

  <section class="about-section">
    <h2>é—œæ–¼é€™è£¡</h2>

    <Toggle title="ä»€éº¼æ˜¯é€™å€‹ç¶²ç«™ï¼Ÿ">
      <p>é€™æ˜¯ä¸€å€‹ç¿»è­¯ blogï¼ŒæŠŠæœ‰è¶£çš„å¤–æ–‡æ–‡ç« ç¿»æˆç¹é«”ä¸­æ–‡åˆ†äº«çµ¦å¤§å®¶ã€‚</p>
    </Toggle>

    <Toggle title="ç‚ºä»€éº¼åšé€™å€‹ï¼Ÿ">
      <p>å› ç‚ºå¥½å…§å®¹ä¸æ‡‰è©²æœ‰èªè¨€éšœç¤™ã€‚è€Œä¸”ç¿»è­¯çš„éç¨‹ä¹Ÿæ˜¯å­¸ç¿’çš„éç¨‹ã€‚</p>
    </Toggle>

    <Toggle title="æŠ€è¡“ç´°ç¯€ï¼ˆçµ¦å·¥ç¨‹å¸«çœ‹çš„ï¼‰" open={false}>
      <p>é€™å€‹ç¶²ç«™ä½¿ç”¨ï¼š</p>
      <ul>
        <li>Astro - éœæ…‹ç¶²ç«™ç”Ÿæˆå™¨</li>
        <li>Claude Opus 4.5 - AI ç¿»è­¯å”åŠ©</li>
        <li>äººå·¥æ ¡å° - ç¢ºä¿å“è³ª</li>
      </ul>
    </Toggle>
  </section>

  <section class="theme-demo">
    <h2>ä¸»é¡Œåˆ‡æ›</h2>
    <p>é»å³ä¸Šè§’çš„åˆ‡æ›æŒ‰éˆ•åˆ‡æ›æ·±è‰²/æ·ºè‰²ï¼ˆSolarized Lightï¼‰æ¨¡å¼</p>
  </section>
</BaseLayout>

<style>
  .site-avatar {
    width: 48px;
    height: 48px;
    border-radius: 50%;
    vertical-align: middle;
    margin-right: 0.5rem;
  }

  .intro {
    color: var(--color-text-muted);
    font-size: 1.1rem;
    margin-bottom: 0.5rem;
  }

  .author-note {
    color: var(--color-accent);
    font-size: 0.9rem;
    margin-bottom: 2rem;
    font-style: italic;
  }

  .posts-section, .about-section, .theme-demo, .clawd-picks-section {
    margin-bottom: 2rem;
  }

  .section-subtitle {
    color: var(--color-text-muted);
    font-size: 0.85rem;
    margin-bottom: 1rem;
  }

  .sd-section h2 {
    color: var(--color-accent);
  }

  .clawd-section-icon {
    width: 24px;
    height: 24px;
    vertical-align: middle;
  }

  .pick-preview {
    padding: 0.5rem 0;
    border-bottom: 1px solid var(--color-border);
    font-size: 0.9rem;
  }

  .pick-preview a {
    color: var(--color-text);
  }

  .pick-preview a:hover {
    color: var(--color-accent);
  }

  .pick-meta {
    display: block;
    color: var(--color-text-muted);
    font-size: 0.75rem;
  }

  .post-preview {
    padding: 1rem 0;
    border-bottom: 1px solid var(--color-border);
  }

  .post-preview h3 {
    margin-bottom: 0.25rem;
  }

  .post-preview h3 a {
    color: var(--color-text);
  }

  .post-preview h3 a:hover {
    color: var(--color-accent);
  }

  .view-all {
    margin-top: 0.75rem;
    text-align: right;
  }

  .view-all a {
    color: var(--color-accent);
    font-size: 0.9rem;
  }

  .view-all a:hover {
    text-decoration: underline;
  }
</style>
