---
import { getCollection } from 'astro:content';
import BaseLayout from '../../layouts/BaseLayout.astro';
import TableOfContents from '../../components/TableOfContents.astro';
import PrevNextNav from '../../components/PrevNextNav.astro';
import TicketBadge from '../../components/TicketBadge.astro';
import Giscus from '../../components/Giscus.astro';
import ShareButton from '../../components/ShareButton.astro';
import LoginCta from '../../components/LoginCta.astro';
import AiPopup from '../../components/AiPopup.astro';

export async function getStaticPaths() {
  const posts = await getCollection('posts', ({ data }) => {
    return data.lang === 'zh-tw';
  });

  return posts.map((post) => ({
    params: { slug: post.slug },
    props: {
      post,
      allPosts: posts,
    },
  }));
}

const { post, allPosts } = Astro.props;
const { Content, headings } = await post.render();

const isClawdPicks = post.data.tags?.includes('clawd-picks');
const ticketId = post.data.ticketId;
const ticketPrefix = ticketId?.split('-')[0] || '';
const isLevelUp = ticketId?.startsWith('Lv-') ?? false;

const ticketLabels: Record<string, string> = {
  SD: 'ShroomDog Original',
  SP: 'ShroomDog Picks',
  CP: 'Clawd Picks',
};
const ticketLabel = ticketLabels[ticketPrefix] || '';
---

<BaseLayout title={`${post.data.title} - gu-log`}>
  <article class="post">
    <header class="post-header">
      <h1>{post.data.title}</h1>
      <div class="post-meta-row">
        <span class="post-meta-left">
          {ticketId && <TicketBadge ticketId={ticketId} />}
          <span class="meta-date">{post.data.translatedDate || post.data.originalDate}</span>
          {
            isClawdPicks && (
              <span class="clawd-picks-badge">
                <img src="/clawd-picks-icon.png" alt="Clawd Picks" class="clawd-icon" />
              </span>
            )
          }
        </span>
        {
          ticketLabel && (
            <span class={`post-meta-label label-${ticketPrefix.toLowerCase()}`}>{ticketLabel}</span>
          )
        }
      </div>
    </header>

    {
      !post.data.ticketId?.startsWith('SD-') && !post.data.ticketId?.startsWith('Lv-') && (
        <div class="source-citation">
          <strong>原文出處：</strong>
          <a href={post.data.sourceUrl} target="_blank" rel="noopener">
            {post.data.source}
          </a>
        </div>
      )
    }

    <TableOfContents lang="zh-tw" headings={headings} maxDepth={isLevelUp ? 2 : 3} />

    <div class="post-content">
      <Content />
    </div>

    {
      post.data.tags && post.data.tags.length > 0 && (
        <div class="post-tags">
          {post.data.tags.map(tag => (
            <a href={`/tags/${tag}`} class="tag-chip">{tag}</a>
          ))}
        </div>
      )
    }

    {
      post.data.translatedDate && post.data.translatedBy && (
        <div class="translation-info">
          翻譯於 {post.data.translatedDate} by {post.data.translatedBy.model} (
          {post.data.translatedBy.harness})
        </div>
      )
    }

    <ShareButton title={post.data.title} lang="zh-tw" />

    <LoginCta lang="zh-tw" />

    <PrevNextNav currentSlug={post.slug} allPosts={allPosts} lang="zh-tw" />

    <Giscus lang="zh-tw" />

    <footer class="post-footer">
      <a href="/">← 返回首頁</a>
    </footer>
  </article>

  <AiPopup filePath={`src/content/posts/${post.id}`} postTitle={post.data.title} lang="zh-tw" />
</BaseLayout>

<style>
  .post-header {
    margin-bottom: 1.5rem;
  }

  .post-header h1 {
    margin-bottom: 0.5rem;
  }

  .post-meta-row {
    display: flex;
    justify-content: space-between;
    align-items: center;
    flex-wrap: wrap;
    gap: 0.5rem;
  }

  .post-meta-left {
    display: flex;
    align-items: center;
    gap: 0.5rem;
  }

  .post-meta-label {
    font-size: 0.85rem;
    font-weight: 500;
    text-align: right;
  }

  .label-sd {
    color: var(--color-badge-sd);
  }

  .label-sp {
    color: var(--color-badge-sp);
  }

  .label-cp {
    color: var(--color-clawd-orange);
  }

  .clawd-picks-badge {
    vertical-align: middle;
  }

  .clawd-icon {
    width: 24px;
    height: 24px;
    vertical-align: middle;
  }

  .meta-date {
    /* removed margin, using gap instead */
  }

  .post-tags {
    display: flex;
    flex-wrap: wrap;
    gap: 0.5rem;
    margin-top: 1rem;
  }

  .tag-chip {
    display: inline-block;
    padding: 0.25rem 0.6rem;
    background-color: var(--color-bg-secondary);
    border: 1px solid var(--color-border);
    border-radius: 16px;
    font-size: 0.85rem;
    color: var(--color-text-muted);
    text-decoration: none;
    transition: all 0.2s ease;
  }

  .tag-chip:hover {
    background-color: var(--color-accent);
    color: var(--color-bg);
    border-color: var(--color-accent);
  }

  .post-content {
    margin: 1.5rem 0;
  }

  .post-content blockquote {
    font-style: normal;
    font-size: 1.1rem;
  }

  .post-footer {
    margin-top: 2rem;
    padding-top: 1rem;
    border-top: 1px solid var(--color-border);
  }

  .translation-info {
    margin-top: 2rem;
    padding: 0.75rem 1rem;
    background-color: var(--color-bg-secondary, rgba(0, 0, 0, 0.03));
    border-radius: 6px;
    font-size: 0.85rem;
    color: var(--color-text-muted);
  }
</style>
