---
import { getCollection } from 'astro:content';
import BaseLayout from '../../layouts/BaseLayout.astro';
import Toggle from '../../components/Toggle.astro';
import TicketBadge from '../../components/TicketBadge.astro';

// Get all EN posts
const allPosts = await getCollection('posts', ({ data }) => {
  return data.lang === 'en';
});

// Helper: extract number from ticketId (e.g., "CP-11" ‚Üí 11)
const getTicketNumber = (ticketId: string | undefined) => {
  if (!ticketId) return 0;
  const match = ticketId.match(/\d+$/);
  return match ? parseInt(match[0]) : 0;
};

// Sort by ticketId number descending (largest first = newest)
const sortByTicketNumber = (a: any, b: any) =>
  getTicketNumber(b.data.ticketId) - getTicketNumber(a.data.ticketId);

// Filter and sort each category
const sdPosts = allPosts
  .filter(p => p.data.ticketId?.startsWith('SD-'))
  .sort(sortByTicketNumber);

const spPosts = allPosts
  .filter(p => p.data.ticketId?.startsWith('SP-'))
  .sort(sortByTicketNumber);

const cpPosts = allPosts
  .filter(p => p.data.ticketId?.startsWith('CP-'))
  .sort(sortByTicketNumber);
---

<BaseLayout title="ShroomDog - Making AI Fun Again" lang="en">
  <h1><img src="/avatar.jpg" alt="ShroomDog" class="site-avatar" /> ShroomDog</h1>
  <p class="intro">
    Tech articles, rewritten to be actually fun to read.
  </p>
  <p class="author-note">
    by ShroomDog and Clawd
  </p>

  {/* SD: ShroomDog Original - Featured */}
  {sdPosts.length > 0 && (
    <section class="posts-section sd-section">
      <h2>üçÑ ShroomDog Original</h2>
      <p class="section-subtitle">Original content by ShroomDog</p>

      {sdPosts.slice(0, 3).map((post) => (
        <article class="post-preview">
          <h3><a href={`/en/posts/${post.slug}`}>{post.data.title}</a></h3>
          <p class="post-meta">
            {post.data.ticketId && <TicketBadge ticketId={post.data.ticketId} />}
            {post.data.translatedDate || post.data.originalDate} ¬∑ {post.data.source}
          </p>
          <Toggle title="Preview">
            <p>{post.data.summary}</p>
          </Toggle>
        </article>
      ))}

      {sdPosts.length > 3 && (
        <p class="view-all"><a href="/en/shroomdog-originals">View all ‚Üí</a></p>
      )}
    </section>
  )}

  {/* SP: ShroomDog Picks */}
  {spPosts.length > 0 && (
    <section class="posts-section sp-section">
      <h2>üìö ShroomDog Picks</h2>
      <p class="section-subtitle">Long-form articles, translated and explained</p>

      {spPosts.slice(0, 3).map((post) => (
        <article class="post-preview">
          <h3><a href={`/en/posts/${post.slug}`}>{post.data.title}</a></h3>
          <p class="post-meta">
            {post.data.ticketId && <TicketBadge ticketId={post.data.ticketId} />}
            {post.data.translatedDate || post.data.originalDate} ¬∑ From {post.data.source}
          </p>
          <Toggle title="Preview">
            <p>{post.data.summary}</p>
          </Toggle>
        </article>
      ))}

      {spPosts.length > 3 && (
        <p class="view-all"><a href="/en/shroomdog-picks">View all ‚Üí</a></p>
      )}
    </section>
  )}

  {/* CP: Clawd Picks */}
  {cpPosts.length > 0 && (
    <section class="clawd-picks-section" id="clawd-picks">
      <h2><img src="/clawd-icon.png" alt="" class="clawd-section-icon" /> Clawd Picks</h2>
      <p class="section-subtitle">One tweet, translated every hour by Clawd</p>

      {cpPosts.slice(0, 5).map((pick) => (
        <article class="pick-preview">
          <a href={`/en/posts/${pick.slug}`}>{pick.data.title}</a>
          <span class="pick-meta">
            {pick.data.ticketId && <TicketBadge ticketId={pick.data.ticketId} />}
            {pick.data.translatedDate || pick.data.originalDate} ¬∑ {pick.data.source}
          </span>
        </article>
      ))}

      {cpPosts.length > 5 && (
        <p class="view-all"><a href="/en/clawd-picks">View all ‚Üí</a></p>
      )}
    </section>
  )}

</BaseLayout>

<style>
  .site-avatar {
    width: 48px;
    height: 48px;
    border-radius: 50%;
    vertical-align: middle;
    margin-right: 0.5rem;
  }

  .intro {
    color: var(--color-text-muted);
    font-size: 1.1rem;
    margin-bottom: 0.5rem;
  }

  .author-note {
    color: var(--color-accent);
    font-size: 0.9rem;
    margin-bottom: 2rem;
    font-style: italic;
  }

  .posts-section, .clawd-picks-section {
    margin-bottom: 2rem;
  }

  .section-subtitle {
    color: var(--color-text-muted);
    font-size: 0.85rem;
    margin-bottom: 1rem;
  }

  .sd-section h2 {
    color: var(--color-accent);
  }

  .clawd-section-icon {
    width: 24px;
    height: 24px;
    vertical-align: middle;
  }

  .pick-preview {
    padding: 0.5rem 0;
    border-bottom: 1px solid var(--color-border);
    font-size: 0.9rem;
  }

  .pick-preview a {
    color: var(--color-text);
  }

  .pick-preview a:hover {
    color: var(--color-accent);
  }

  .pick-meta {
    display: block;
    color: var(--color-text-muted);
    font-size: 0.75rem;
  }

  .post-preview {
    padding: 1rem 0;
    border-bottom: 1px solid var(--color-border);
  }

  .post-preview h3 {
    margin-bottom: 0.25rem;
  }

  .post-preview h3 a {
    color: var(--color-text);
  }

  .post-preview h3 a:hover {
    color: var(--color-accent);
  }

  .view-all {
    margin-top: 0.75rem;
    text-align: right;
  }

  .view-all a {
    color: var(--color-accent);
    font-size: 0.9rem;
  }

  .view-all a:hover {
    text-decoration: underline;
  }
</style>
