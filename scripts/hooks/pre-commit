#!/bin/sh
# Pre-commit hook for gu-log
# Runs: 0) Quick duplicate ticketId check (fast, shell-based)
#       1) Content integrity tests (ticketId uniqueness - Playwright)
#       2) AI review for staged posts (serial, max 5, advisory only)

set -e
POSTS_DIR="src/content/posts"

# 0. Quick Duplicate ticketId Check (fast shell-based, ~100ms)
echo "‚ö° Quick ticketId duplicate check..."
DUPLICATES=$(grep -h 'ticketId:' "$POSTS_DIR"/*.mdx 2>/dev/null | \
    sed 's/.*ticketId:[[:space:]]*["'"'"']\([^"'"'"']*\)["'"'"'].*/\1/' | \
    sort | uniq -c | sort -rn | awk '$1 > 2 {print $2 " (" $1 " occurrences)"}')

if [ -n "$DUPLICATES" ]; then
    echo ""
    echo "‚ùå DUPLICATE ticketId DETECTED (more than 2 occurrences = not a translation pair):"
    echo "$DUPLICATES"
    echo ""
    echo "Each ticketId should appear exactly 2 times (zh-tw + en version)."
    echo "Fix the duplicates before committing."
    exit 1
fi
echo "‚úì No duplicate ticketIds"
echo ""

# 1. Content Integrity Tests (BDD - Playwright)
# Only run if playwright is available and tests exist
if [ -f "tests/content-integrity.spec.ts" ]; then
    echo "üß™ Running content integrity tests..."
    if npx playwright test tests/content-integrity.spec.ts --project='Desktop Chrome' --reporter=line 2>&1; then
        echo "‚úì Content integrity tests passed"
    else
        echo ""
        echo "‚ùå Content integrity tests FAILED."
        echo "   Fix ticketId conflicts before committing."
        exit 1
    fi
    echo ""
fi

# 2. AI Review for staged .mdx posts (advisory, non-blocking)
# - Serial to avoid OOM on low-RAM machines (2GB CPX11)
# - Max 5 files to avoid timeout
# - Skipped if no .mdx files staged
STAGED_MDX=$(git diff --cached --name-only --diff-filter=ACM -- "$POSTS_DIR"/*.mdx 2>/dev/null || true)

if [ -z "$STAGED_MDX" ]; then
    echo "‚úì No .mdx files to review"
else
    FILE_COUNT=$(echo "$STAGED_MDX" | wc -l)
    MAX_REVIEW=5

    if [ "$FILE_COUNT" -gt "$MAX_REVIEW" ]; then
        echo "üìù $FILE_COUNT .mdx files staged ‚Äî reviewing first $MAX_REVIEW only (skip rest to avoid OOM)"
        STAGED_MDX=$(echo "$STAGED_MDX" | head -n "$MAX_REVIEW")
    else
        echo "üìù Reviewing $FILE_COUNT staged .mdx file(s)..."
    fi

    # Review each file serially (advisory ‚Äî failures don't block commit)
    for file in $STAGED_MDX; do
        echo ""
        echo "üîç Reviewing: $file"
        # Simple checks: frontmatter exists, ticketId present, lang set
        if ! head -1 "$file" | grep -q '^---'; then
            echo "  ‚ö†Ô∏è  Missing frontmatter"
        fi
        if ! grep -q 'ticketId:' "$file"; then
            echo "  ‚ö†Ô∏è  Missing ticketId"
        fi
        if ! grep -q 'lang:' "$file"; then
            echo "  ‚ö†Ô∏è  Missing lang field"
        fi
        if ! grep -q 'source:' "$file"; then
            echo "  ‚ö†Ô∏è  Missing source field"
        fi
        echo "  ‚úì Basic checks passed"
    done
fi

echo ""
echo "‚úì All pre-commit checks passed!"
exit 0
