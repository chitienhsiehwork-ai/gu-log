#!/bin/sh
# Pre-commit hook for gu-log
# Runs: 0) Quick duplicate ticketId check (fast, shell-based)
#       1) Content integrity tests (ticketId uniqueness - Playwright)
#       2) AI review for staged posts
#       3) Visual test (advisory)

set -e
SCRIPT_DIR="$(cd "$(dirname "$0")" && pwd)"
POSTS_DIR="src/content/posts"

# 0. Quick Duplicate ticketId Check (fast shell-based, ~100ms)
echo "‚ö° Quick ticketId duplicate check..."
DUPLICATES=$(grep -h 'ticketId:' "$POSTS_DIR"/*.mdx 2>/dev/null | \
    sed 's/.*ticketId:[[:space:]]*["'"'"']\([^"'"'"']*\)["'"'"'].*/\1/' | \
    sort | uniq -c | sort -rn | awk '$1 > 2 {print $2 " (" $1 " occurrences)"}')

if [ -n "$DUPLICATES" ]; then
    echo ""
    echo "‚ùå DUPLICATE ticketId DETECTED (more than 2 occurrences = not a translation pair):"
    echo "$DUPLICATES"
    echo ""
    echo "Each ticketId should appear exactly 2 times (zh-tw + en version)."
    echo "Fix the duplicates before committing."
    exit 1
fi
echo "‚úì No duplicate ticketIds"
echo ""

# 1. Content Integrity Tests (BDD - Playwright)
echo "üß™ Running content integrity tests..."
if ! npx playwright test tests/content-integrity.spec.ts --project='Desktop Chrome' --reporter=line 2>&1; then
    echo ""
    echo "‚ùå Content integrity tests FAILED."
    echo "   Fix ticketId conflicts before committing."
    echo "   To bypass (not recommended): git commit --no-verify"
    exit 1
fi
echo "‚úì Content integrity tests passed"
echo ""

# 2. AI Review for staged posts
"$SCRIPT_DIR/review-posts.sh"

# 3. Visual test with LLM review (blocking)
echo ""
echo "üì∏ Running visual test with LLM review..."
if ! node "$SCRIPT_DIR/visual-test.mjs" 2>&1; then
    echo ""
    echo "‚ùå Visual test FAILED."
    echo "   Fix the UI issues before committing."
    echo "   To bypass (not recommended): git commit --no-verify"
    exit 1
fi

echo ""
echo "‚úì All pre-commit checks passed!"
exit 0
