{"id":"39f3ff83b9a507a33de5de60c34ea9794f0aa5ac","url":"http://localhost:4321/src/components/TableOfContents.astro?astro&type=script&index=0&lang.ts","source":"function initTableOfContents() {\n  const tocContainer = document.querySelector(\".toc-container\");\n  if (!tocContainer) return;\n  const tocLinks = Array.from(document.querySelectorAll(\".toc-link\"));\n  const headingIds = tocLinks.map((link) => link.getAttribute(\"data-heading-id\")).filter(Boolean);\n  const headings = headingIds.map((id) => document.getElementById(id)).filter(Boolean);\n  if (headings.length === 0) return;\n  setupScrollHighlight(headings);\n  setupSmoothScroll();\n}\nfunction setupScrollHighlight(headings) {\n  let ticking = false;\n  function updateActiveHeading() {\n    const scrollPos = window.scrollY + 100;\n    let currentHeading = headings[0];\n    for (const heading of headings) {\n      const offsetTop = heading.getBoundingClientRect().top + window.scrollY;\n      if (offsetTop <= scrollPos) {\n        currentHeading = heading;\n      } else {\n        break;\n      }\n    }\n    document.querySelectorAll(\".toc-link\").forEach((link) => {\n      link.classList.remove(\"active\");\n    });\n    if (currentHeading?.id) {\n      document.querySelectorAll(`[data-heading-id=\"${currentHeading.id}\"]`).forEach((link) => {\n        link.classList.add(\"active\");\n      });\n    }\n    ticking = false;\n  }\n  function onScroll() {\n    if (!ticking) {\n      requestAnimationFrame(updateActiveHeading);\n      ticking = true;\n    }\n  }\n  window.addEventListener(\"scroll\", onScroll, { passive: true });\n  updateActiveHeading();\n}\nfunction setupSmoothScroll() {\n  const SCROLL_OFFSET = 80;\n  const TOC_COLLAPSE_DURATION = 400;\n  document.querySelectorAll(\".toc-link\").forEach((link) => {\n    link.addEventListener(\"click\", (e) => {\n      e.preventDefault();\n      const href = e.currentTarget?.getAttribute(\"href\");\n      if (!href) return;\n      const targetId = href.replace(\"#\", \"\");\n      const target = document.getElementById(targetId);\n      if (target) {\n        const mobileContainer = document.querySelector(\".toc-mobile .toc-toggle-container\");\n        const isMobileOpen = window.innerWidth < 1280 && mobileContainer?.getAttribute(\"data-open\") === \"true\";\n        if (isMobileOpen) {\n          mobileContainer.setAttribute(\"data-open\", \"false\");\n          mobileContainer.querySelector(\".toc-toggle-header\")?.setAttribute(\"aria-expanded\", \"false\");\n          setTimeout(() => {\n            const targetTop = target.getBoundingClientRect().top + window.scrollY - SCROLL_OFFSET;\n            window.scrollTo({ top: targetTop, behavior: \"instant\" });\n          }, TOC_COLLAPSE_DURATION);\n        } else {\n          const targetTop = target.getBoundingClientRect().top + window.scrollY - SCROLL_OFFSET;\n          window.scrollTo({ top: targetTop, behavior: \"smooth\" });\n        }\n        history.pushState(null, \"\", href);\n      }\n    });\n  });\n}\nfunction setupMobileToggle() {\n  const tocMobile = document.querySelector(\".toc-mobile\");\n  if (!tocMobile) return;\n  const toggleHeader = tocMobile.querySelector(\".toc-toggle-header\");\n  const container = tocMobile.querySelector(\".toc-toggle-container\");\n  if (!toggleHeader || !container) return;\n  toggleHeader.addEventListener(\"click\", () => {\n    const isOpen = container.getAttribute(\"data-open\") === \"true\";\n    container.setAttribute(\"data-open\", (!isOpen).toString());\n    toggleHeader.setAttribute(\"aria-expanded\", (!isOpen).toString());\n  });\n}\ninitTableOfContents();\nsetupMobileToggle();\ndocument.addEventListener(\"astro:page-load\", () => {\n  initTableOfContents();\n  setupMobileToggle();\n});\n","sourceMap":{"version":3,"sources":["TableOfContents.astro"],"sourcesContent":["---\n/**\n * Table of Contents Component (Build-time generated)\n *\n * Receives headings from post.render() and generates TOC at build time:\n * - Mobile: Collapsible TOC at top of article\n * - Desktop (>1280px): Sticky sidebar TOC\n * - Highlights current section on scroll (client JS)\n * - Only shows if 2+ headings exist\n */\n\ninterface Heading {\n  depth: number;\n  slug: string;\n  text: string;\n}\n\ninterface Props {\n  lang?: 'zh-tw' | 'en';\n  headings?: Heading[];\n}\n\nconst { lang = 'zh-tw', headings = [] } = Astro.props;\n\n// Filter to only h2 and h3\nconst tocHeadings = headings.filter(h => h.depth === 2 || h.depth === 3);\n\n// Only show TOC if 2+ headings\nconst showToc = tocHeadings.length >= 2;\n\nconst labels = {\n  'zh-tw': {\n    title: '目錄',\n  },\n  'en': {\n    title: 'Table of Contents',\n  }\n};\n\nconst t = labels[lang];\n---\n\n{showToc && (\n  <aside class=\"toc-container\" aria-label={t.title}>\n    <!-- Mobile Toggle Version -->\n    <div class=\"toc-mobile\">\n      <div class=\"toc-toggle-container\" data-open=\"false\">\n        <button class=\"toc-toggle-header\" aria-expanded=\"false\">\n          <span class=\"toc-toggle-icon\"></span>\n          <span class=\"toc-toggle-title\">{t.title}</span>\n        </button>\n        <div class=\"toc-toggle-wrapper\">\n          <div class=\"toc-toggle-inner\">\n            <nav class=\"toc-content\">\n              {tocHeadings.map((heading) => (\n                <a \n                  href={`#${heading.slug}`}\n                  class={`toc-link toc-link-h${heading.depth}`}\n                  data-heading-id={heading.slug}\n                >\n                  {heading.text}\n                </a>\n              ))}\n            </nav>\n          </div>\n        </div>\n      </div>\n    </div>\n\n    <!-- Desktop Sidebar Version -->\n    <div class=\"toc-desktop\">\n      <nav class=\"toc-sidebar\">\n        <h2 class=\"toc-title\">{t.title}</h2>\n        <div class=\"toc-content\">\n          {tocHeadings.map((heading) => (\n            <a \n              href={`#${heading.slug}`}\n              class={`toc-link toc-link-h${heading.depth}`}\n              data-heading-id={heading.slug}\n            >\n              {heading.text}\n            </a>\n          ))}\n        </div>\n      </nav>\n    </div>\n  </aside>\n)}\n\n<script>\n  function initTableOfContents() {\n    const tocContainer = document.querySelector('.toc-container');\n    if (!tocContainer) return;\n\n    // Get all heading IDs from TOC links\n    const tocLinks = Array.from(document.querySelectorAll('.toc-link'));\n    const headingIds = tocLinks.map(link => link.getAttribute('data-heading-id')).filter(Boolean);\n    const headings = headingIds.map(id => document.getElementById(id!)).filter(Boolean) as HTMLElement[];\n\n    if (headings.length === 0) return;\n\n    // Set up scroll highlighting\n    setupScrollHighlight(headings);\n\n    // Set up smooth scrolling\n    setupSmoothScroll();\n    \n    // Note: Mobile toggle is handled by Toggle component's event delegation\n  }\n\n  function setupScrollHighlight(headings: HTMLElement[]) {\n    let ticking = false;\n\n    function updateActiveHeading() {\n      const scrollPos = window.scrollY + 100;\n\n      let currentHeading = headings[0];\n      for (const heading of headings) {\n        const offsetTop = heading.getBoundingClientRect().top + window.scrollY;\n        if (offsetTop <= scrollPos) {\n          currentHeading = heading;\n        } else {\n          break;\n        }\n      }\n\n      document.querySelectorAll('.toc-link').forEach(link => {\n        link.classList.remove('active');\n      });\n\n      if (currentHeading?.id) {\n        document.querySelectorAll(`[data-heading-id=\"${currentHeading.id}\"]`).forEach(link => {\n          link.classList.add('active');\n        });\n      }\n\n      ticking = false;\n    }\n\n    function onScroll() {\n      if (!ticking) {\n        requestAnimationFrame(updateActiveHeading);\n        ticking = true;\n      }\n    }\n\n    window.addEventListener('scroll', onScroll, { passive: true });\n    updateActiveHeading();\n  }\n\n  function setupSmoothScroll() {\n    const SCROLL_OFFSET = 80; // px offset from top to account for reading progress bar etc.\n    const TOC_COLLAPSE_DURATION = 400; // ms — CSS transition is 300ms cubic-bezier + 100ms buffer\n\n    document.querySelectorAll('.toc-link').forEach(link => {\n      link.addEventListener('click', (e) => {\n        e.preventDefault();\n        const href = (e.currentTarget as HTMLElement)?.getAttribute('href');\n        if (!href) return;\n\n        const targetId = href.replace('#', '');\n        const target = document.getElementById(targetId);\n        \n        if (target) {\n          // CRITICAL: Close mobile TOC FIRST, then scroll AFTER collapse animation.\n          // Bug: if we calculate scroll position while TOC is open (~683px tall),\n          // then TOC collapses and page shrinks, the scroll target is off by the TOC height.\n          const mobileContainer = document.querySelector('.toc-mobile .toc-toggle-container');\n          const isMobileOpen = window.innerWidth < 1280 && \n            mobileContainer?.getAttribute('data-open') === 'true';\n\n          if (isMobileOpen) {\n            // Close TOC first\n            mobileContainer!.setAttribute('data-open', 'false');\n            mobileContainer!.querySelector('.toc-toggle-header')?.setAttribute('aria-expanded', 'false');\n\n            // Wait for collapse animation to finish, THEN calculate position and scroll.\n            // Use 'instant' on mobile: smooth scroll on very long pages often undershoots\n            // because the browser caps the animation duration, leaving you 1-2 screens off.\n            setTimeout(() => {\n              const targetTop = target.getBoundingClientRect().top + window.scrollY - SCROLL_OFFSET;\n              window.scrollTo({ top: targetTop, behavior: 'instant' });\n            }, TOC_COLLAPSE_DURATION);\n          } else {\n            // Desktop or TOC already closed — smooth scroll is fine here\n            const targetTop = target.getBoundingClientRect().top + window.scrollY - SCROLL_OFFSET;\n            window.scrollTo({ top: targetTop, behavior: 'smooth' });\n          }\n\n          history.pushState(null, '', href);\n        }\n      });\n    });\n  }\n\n  function setupMobileToggle() {\n    // Handle TOC mobile toggle click with dedicated class names (avoid Toggle component conflict)\n    const tocMobile = document.querySelector('.toc-mobile');\n    if (!tocMobile) return;\n\n    const toggleHeader = tocMobile.querySelector('.toc-toggle-header');\n    const container = tocMobile.querySelector('.toc-toggle-container');\n    \n    if (!toggleHeader || !container) return;\n\n    toggleHeader.addEventListener('click', () => {\n      const isOpen = container.getAttribute('data-open') === 'true';\n      container.setAttribute('data-open', (!isOpen).toString());\n      toggleHeader.setAttribute('aria-expanded', (!isOpen).toString());\n    });\n  }\n\n  // Initialize\n  initTableOfContents();\n  setupMobileToggle();\n  document.addEventListener('astro:page-load', () => {\n    initTableOfContents();\n    setupMobileToggle();\n  });\n</script>\n\n<style>\n  .toc-container {\n    margin: 1.5rem 0;\n  }\n\n  .toc-mobile {\n    display: block;\n  }\n\n  .toc-desktop {\n    display: none;\n  }\n\n  .toc-toggle-container {\n    border-radius: 8px;\n    background: var(--color-surface);\n    overflow: hidden;\n  }\n\n  .toc-toggle-header {\n    display: flex;\n    align-items: center;\n    gap: 0.5rem;\n    padding: 0.75rem 1rem;\n    width: 100%;\n    background: none;\n    border: none;\n    color: inherit;\n    font-family: inherit;\n    font-size: inherit;\n    cursor: pointer;\n    text-align: left;\n    outline: none;\n    -webkit-tap-highlight-color: transparent;\n  }\n\n  .toc-toggle-icon {\n    width: 0;\n    height: 0;\n    border-left: 6px solid var(--color-text);\n    border-top: 5px solid transparent;\n    border-bottom: 5px solid transparent;\n    transition: transform 0.3s ease;\n    flex-shrink: 0;\n  }\n\n  .toc-toggle-container[data-open=\"true\"] .toc-toggle-icon {\n    transform: rotate(90deg);\n  }\n\n  .toc-toggle-title {\n    flex: 1;\n    font-weight: 600;\n    font-size: 0.95rem;\n  }\n\n  .toc-toggle-wrapper {\n    display: grid;\n    grid-template-rows: 0fr;\n    transition: grid-template-rows 0.3s cubic-bezier(0.4, 0, 0.2, 1);\n  }\n\n  .toc-toggle-container[data-open=\"true\"] .toc-toggle-wrapper {\n    grid-template-rows: 1fr;\n  }\n\n  .toc-toggle-inner {\n    overflow: hidden;\n  }\n\n  .toc-content {\n    display: flex;\n    flex-direction: column;\n    gap: 0.3rem;\n  }\n\n  .toc-mobile .toc-content {\n    padding: 0.5rem 1rem 1rem 1.75rem;\n  }\n\n  .toc-link {\n    color: var(--color-text-muted);\n    text-decoration: none;\n    font-size: 0.9rem;\n    line-height: 1.5;\n    transition: color 0.2s ease;\n    padding: 0.2rem 0;\n  }\n\n  .toc-link:hover {\n    color: var(--color-accent);\n  }\n\n  .toc-link.active {\n    color: var(--color-accent);\n    font-weight: 500;\n  }\n\n  .toc-link-h3 {\n    padding-left: 1rem;\n    font-size: 0.85rem;\n  }\n\n  @media (min-width: 1280px) {\n    .toc-mobile {\n      display: none;\n    }\n\n    .toc-desktop {\n      display: block;\n      position: fixed;\n      right: max(1rem, calc((100vw - 680px) / 2 - 220px));\n      top: 6rem;\n      width: 200px;\n      max-height: calc(100vh - 8rem);\n      overflow-y: auto;\n    }\n\n    .toc-sidebar {\n      padding: 1rem;\n      background: var(--color-surface);\n      border-radius: 8px;\n      border: 1px solid var(--color-border);\n    }\n\n    .toc-title {\n      font-size: 0.95rem;\n      font-weight: 600;\n      margin-bottom: 0.75rem;\n      color: var(--color-text);\n    }\n\n    .toc-desktop .toc-content {\n      padding: 0;\n    }\n\n    .toc-desktop::-webkit-scrollbar {\n      width: 4px;\n    }\n\n    .toc-desktop::-webkit-scrollbar-track {\n      background: transparent;\n    }\n\n    .toc-desktop::-webkit-scrollbar-thumb {\n      background: var(--color-border);\n      border-radius: 4px;\n    }\n  }\n\n  @media (min-width: 1400px) {\n    .toc-desktop {\n      right: max(2rem, calc((100vw - 680px) / 2 - 260px));\n      width: 240px;\n    }\n  }\n\n  @media (pointer: coarse) {\n    .toc-toggle-header {\n      padding: 1rem;\n      min-height: 48px;\n    }\n\n    .toc-link {\n      padding: 0.4rem 0;\n      min-height: 44px;\n      display: flex;\n      align-items: center;\n    }\n  }\n</style>"],"mappings":"AA0FE,SAAS,sBAAsB;AAC7B,QAAM,eAAe,SAAS,cAAc,gBAAgB;AAC5D,MAAI,CAAC,aAAc;AAGnB,QAAM,WAAW,MAAM,KAAK,SAAS,iBAAiB,WAAW,CAAC;AAClE,QAAM,aAAa,SAAS,IAAI,UAAQ,KAAK,aAAa,iBAAiB,CAAC,EAAE,OAAO,OAAO;AAC5F,QAAM,WAAW,WAAW,IAAI,QAAM,SAAS,eAAe,EAAG,CAAC,EAAE,OAAO,OAAO;AAElF,MAAI,SAAS,WAAW,EAAG;AAG3B,uBAAqB,QAAQ;AAG7B,oBAAkB;AAGpB;AAEA,SAAS,qBAAqB,UAAyB;AACrD,MAAI,UAAU;AAEd,WAAS,sBAAsB;AAC7B,UAAM,YAAY,OAAO,UAAU;AAEnC,QAAI,iBAAiB,SAAS,CAAC;AAC/B,eAAW,WAAW,UAAU;AAC9B,YAAM,YAAY,QAAQ,sBAAsB,EAAE,MAAM,OAAO;AAC/D,UAAI,aAAa,WAAW;AAC1B,yBAAiB;MACnB,OAAO;AACL;MACF;IACF;AAEA,aAAS,iBAAiB,WAAW,EAAE,QAAQ,UAAQ;AACrD,WAAK,UAAU,OAAO,QAAQ;IAChC,CAAC;AAED,QAAI,gBAAgB,IAAI;AACtB,eAAS,iBAAiB,qBAAqB,eAAe,EAAE,IAAI,EAAE,QAAQ,UAAQ;AACpF,aAAK,UAAU,IAAI,QAAQ;MAC7B,CAAC;IACH;AAEA,cAAU;EACZ;AAEA,WAAS,WAAW;AAClB,QAAI,CAAC,SAAS;AACZ,4BAAsB,mBAAmB;AACzC,gBAAU;IACZ;EACF;AAEA,SAAO,iBAAiB,UAAU,UAAU,EAAE,SAAS,KAAK,CAAC;AAC7D,sBAAoB;AACtB;AAEA,SAAS,oBAAoB;AAC3B,QAAM,gBAAgB;AACtB,QAAM,wBAAwB;AAE9B,WAAS,iBAAiB,WAAW,EAAE,QAAQ,UAAQ;AACrD,SAAK,iBAAiB,SAAS,CAAC,MAAM;AACpC,QAAE,eAAe;AACjB,YAAM,OAAQ,EAAE,eAA+B,aAAa,MAAM;AAClE,UAAI,CAAC,KAAM;AAEX,YAAM,WAAW,KAAK,QAAQ,KAAK,EAAE;AACrC,YAAM,SAAS,SAAS,eAAe,QAAQ;AAE/C,UAAI,QAAQ;AAIV,cAAM,kBAAkB,SAAS,cAAc,mCAAmC;AAClF,cAAM,eAAe,OAAO,aAAa,QACvC,iBAAiB,aAAa,WAAW,MAAM;AAEjD,YAAI,cAAc;AAEhB,0BAAiB,aAAa,aAAa,OAAO;AAClD,0BAAiB,cAAc,oBAAoB,GAAG,aAAa,iBAAiB,OAAO;AAK3F,qBAAW,MAAM;AACf,kBAAM,YAAY,OAAO,sBAAsB,EAAE,MAAM,OAAO,UAAU;AACxE,mBAAO,SAAS,EAAE,KAAK,WAAW,UAAU,UAAU,CAAC;UACzD,GAAG,qBAAqB;QAC1B,OAAO;AAEL,gBAAM,YAAY,OAAO,sBAAsB,EAAE,MAAM,OAAO,UAAU;AACxE,iBAAO,SAAS,EAAE,KAAK,WAAW,UAAU,SAAS,CAAC;QACxD;AAEA,gBAAQ,UAAU,MAAM,IAAI,IAAI;MAClC;IACF,CAAC;EACH,CAAC;AACH;AAEA,SAAS,oBAAoB;AAE3B,QAAM,YAAY,SAAS,cAAc,aAAa;AACtD,MAAI,CAAC,UAAW;AAEhB,QAAM,eAAe,UAAU,cAAc,oBAAoB;AACjE,QAAM,YAAY,UAAU,cAAc,uBAAuB;AAEjE,MAAI,CAAC,gBAAgB,CAAC,UAAW;AAEjC,eAAa,iBAAiB,SAAS,MAAM;AAC3C,UAAM,SAAS,UAAU,aAAa,WAAW,MAAM;AACvD,cAAU,aAAa,cAAc,CAAC,QAAQ,SAAS,CAAC;AACxD,iBAAa,aAAa,kBAAkB,CAAC,QAAQ,SAAS,CAAC;EACjE,CAAC;AACH;AAGA,oBAAoB;AACpB,kBAAkB;AAClB,SAAS,iBAAiB,mBAAmB,MAAM;AACjD,sBAAoB;AACpB,oBAAkB;AACpB,CAAC;","names":[]}}