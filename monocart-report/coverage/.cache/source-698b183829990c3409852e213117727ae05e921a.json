{"id":"698b183829990c3409852e213117727ae05e921a","url":"http://localhost:4321/","source":"(function(){const noResultsText = \"找不到結果\";\nconst currentLang = \"zh-tw\";\nconst maxResults = 5;\nconst debounceMs = 150;\nconst enableTicketSearch = true;\n\n  // Search state\n  let searchIndex = null;\n  let debounceTimer = null;\n  let selectedIndex = -1;\n\n  const trigger = document.querySelector('[data-search-trigger]');\n  const modal = document.querySelector('[data-search-modal]');\n  const input = modal?.querySelector('[data-search-input]');\n  const results = modal?.querySelector('[data-search-results]');\n\n  // Fetch search index on first open\n  async function loadSearchIndex() {\n    if (searchIndex) return;\n    try {\n      const res = await fetch('/search-index.json');\n      searchIndex = await res.json();\n    } catch (e) {\n      console.error('Failed to load search index:', e);\n    }\n  }\n\n  // Open search modal\n  function openSearch() {\n    modal?.setAttribute('aria-hidden', 'false');\n    document.body.style.overflow = 'hidden';\n    loadSearchIndex();\n    setTimeout(() => input?.focus(), 50);\n  }\n\n  // Close search modal\n  function closeSearch() {\n    modal?.setAttribute('aria-hidden', 'true');\n    document.body.style.overflow = '';\n    if (input) input.value = '';\n    if (results) results.innerHTML = '';\n    selectedIndex = -1;\n  }\n\n  // Toggle search\n  function toggleSearch() {\n    const isHidden = modal?.getAttribute('aria-hidden') === 'true';\n    if (isHidden) {\n      openSearch();\n    } else {\n      closeSearch();\n    }\n  }\n\n  // Search and display results\n  function performSearch(query) {\n    if (!searchIndex || !results) return;\n\n    const trimmed = query.trim().toLowerCase();\n    if (!trimmed) {\n      results.innerHTML = '';\n      selectedIndex = -1;\n      return;\n    }\n\n    // Filter by current language and search query\n    const filtered = searchIndex\n      .filter((post) => post.lang === currentLang)\n      .filter((post) => {\n        // Check ticket ID first (exact match, case insensitive)\n        if (enableTicketSearch && post.ticketId) {\n          if (post.ticketId.toLowerCase() === trimmed) {\n            return true;\n          }\n          // Also match partial ticket ID (e.g., \"SD\" matches \"SD-1\")\n          if (post.ticketId.toLowerCase().startsWith(trimmed)) {\n            return true;\n          }\n        }\n\n        // Then check title, summary, source, tags\n        const searchable = [\n          post.ticketId || '',\n          post.title,\n          post.summary,\n          post.source,\n          ...(post.tags || []),\n        ]\n          .join(' ')\n          .toLowerCase();\n        return searchable.includes(trimmed);\n      })\n      .slice(0, maxResults);\n\n    if (filtered.length === 0) {\n      results.innerHTML = `<div class=\"search-no-results\">${noResultsText}</div>`;\n      selectedIndex = -1;\n      return;\n    }\n\n    // Render results with proper formatting\n    const baseUrl = currentLang === 'en' ? '/en/posts/' : '/posts/';\n    results.innerHTML = filtered\n      .map((post, index) => {\n        // Remove 'en-' prefix from slug for en posts\n        const displaySlug =\n          post.lang === 'en' && post.slug.startsWith('en-') ? post.slug.slice(3) : post.slug;\n\n        const ticketBadge = post.ticketId\n          ? `<span class=\"search-result-ticket\">${escapeHtml(post.ticketId)}</span>`\n          : '';\n\n        return `\n        <a href=\"${baseUrl}${displaySlug}\"\n           class=\"search-result-item\"\n           role=\"option\"\n           data-index=\"${index}\">\n          <div class=\"search-result-header\">\n            ${ticketBadge}\n            <span class=\"search-result-date\">${post.date}</span>\n          </div>\n          <div class=\"search-result-title\">${escapeHtml(post.title)}</div>\n          <div class=\"search-result-source\">${escapeHtml(post.source)}</div>\n        </a>\n      `;\n      })\n      .join('');\n\n    selectedIndex = -1;\n  }\n\n  // Escape HTML to prevent XSS\n  function escapeHtml(text) {\n    const div = document.createElement('div');\n    div.textContent = text;\n    return div.innerHTML;\n  }\n\n  // Update selection highlight\n  function updateSelection() {\n    const items = results?.querySelectorAll('.search-result-item');\n    items?.forEach((item, i) => {\n      item.classList.toggle('selected', i === selectedIndex);\n    });\n  }\n\n  // Navigate to selected result\n  function navigateToSelected() {\n    const items = results?.querySelectorAll('.search-result-item');\n    if (items && selectedIndex >= 0 && selectedIndex < items.length) {\n      const href = items[selectedIndex].getAttribute('href');\n      if (href) window.location.href = href;\n    }\n  }\n\n  // Event listeners\n  trigger?.addEventListener('click', (e) => {\n    e.preventDefault();\n    openSearch();\n  });\n\n  // Close on overlay click\n  modal?.addEventListener('click', (e) => {\n    if (e.target === modal) {\n      closeSearch();\n    }\n  });\n\n  input?.addEventListener('input', (e) => {\n    clearTimeout(debounceTimer);\n    debounceTimer = setTimeout(() => {\n      performSearch(e.target.value);\n    }, debounceMs);\n  });\n\n  input?.addEventListener('keydown', (e) => {\n    const items = results?.querySelectorAll('.search-result-item');\n    const itemCount = items?.length || 0;\n\n    switch (e.key) {\n      case 'Escape':\n        e.preventDefault();\n        closeSearch();\n        trigger?.focus();\n        break;\n      case 'ArrowDown':\n        e.preventDefault();\n        if (itemCount > 0) {\n          selectedIndex = (selectedIndex + 1) % itemCount;\n          updateSelection();\n        }\n        break;\n      case 'ArrowUp':\n        e.preventDefault();\n        if (itemCount > 0) {\n          selectedIndex = selectedIndex <= 0 ? itemCount - 1 : selectedIndex - 1;\n          updateSelection();\n        }\n        break;\n      case 'Enter':\n        e.preventDefault();\n        if (selectedIndex >= 0) {\n          navigateToSelected();\n        }\n        break;\n    }\n  });\n\n  // Global Cmd/Ctrl+K shortcut\n  document.addEventListener('keydown', (e) => {\n    if ((e.metaKey || e.ctrlKey) && e.key === 'k') {\n      e.preventDefault();\n      toggleSearch();\n    }\n  });\n})();"}