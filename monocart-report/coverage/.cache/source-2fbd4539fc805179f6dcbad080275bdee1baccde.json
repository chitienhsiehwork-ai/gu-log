{"id":"2fbd4539fc805179f6dcbad080275bdee1baccde","url":"http://localhost:4321/posts/subagent-showdown-claude-code-vs-openclaw","source":"\n(function() {\n  'use strict';\n\n  var JWT_KEY = 'gu-log-jwt';\n  var RETURN_KEY = 'gu-log-return-url';\n\n  var root = document.getElementById('ai-popup-root');\n  if (!root) return;\n\n  var filePath = root.getAttribute('data-file-path') || '';\n  var postTitle = root.getAttribute('data-post-title') || '';\n  var apiUrl = root.getAttribute('data-api-url') || '';\n  var lang = root.getAttribute('data-lang') || 'zh-tw';\n\n  // i18n\n  var t = lang === 'en' ? {\n    askAi: 'ü§ñ Ask AI',\n    edit: '‚úèÔ∏è Edit',\n    login: 'üîê Login with GitHub',\n    loading: 'Thinking...',\n    close: '‚úï',\n    confirm: '‚úÖ Confirm',\n    cancel: '‚ùå Cancel',\n    committed: 'Committed!',\n    error: 'Something went wrong. Please try again.'\n  } : {\n    askAi: 'ü§ñ Ask AI',\n    edit: '‚úèÔ∏è Edit',\n    login: 'üîê Login with GitHub',\n    loading: 'ÊÄùËÄÉ‰∏≠...',\n    close: '‚úï',\n    confirm: '‚úÖ Á¢∫Ë™ç',\n    cancel: '‚ùå ÂèñÊ∂à',\n    committed: 'Â∑≤Êèê‰∫§ÔºÅ',\n    error: 'ÁôºÁîüÈåØË™§ÔºåË´ãÂÜçË©¶‰∏ÄÊ¨°„ÄÇ'\n  };\n\n  var popup = null;\n  var selectedText = '';\n  var currentState = 'idle'; // idle, buttons, loading, ask-result, edit-result, confirm-loading, committed, error\n  var pendingEditId = null;\n\n  function getJwt() {\n    try {\n      return localStorage.getItem(JWT_KEY);\n    } catch(e) {\n      return null;\n    }\n  }\n\n  function isLoggedIn() {\n    return !!getJwt();\n  }\n\n  function escapeHtml(str) {\n    var div = document.createElement('div');\n    div.textContent = str;\n    return div.innerHTML;\n  }\n\n  function createPopup() {\n    if (popup) popup.remove();\n\n    popup = document.createElement('div');\n    popup.id = 'ai-popup';\n    popup.className = 'ai-popup';\n    popup.setAttribute('role', 'dialog');\n    popup.setAttribute('aria-label', 'AI Popup');\n    document.body.appendChild(popup);\n    return popup;\n  }\n\n  function removePopup() {\n    if (popup) {\n      popup.remove();\n      popup = null;\n    }\n    currentState = 'idle';\n    pendingEditId = null;\n  }\n\n  function positionPopup(rect) {\n    if (!popup) return;\n\n    var isMobile = window.innerWidth < 640;\n\n    if (isMobile) {\n      // Bottom sheet style\n      popup.classList.add('ai-popup--mobile');\n      popup.classList.remove('ai-popup--desktop');\n    } else {\n      // Float near selection\n      popup.classList.remove('ai-popup--mobile');\n      popup.classList.add('ai-popup--desktop');\n\n      var popupRect = popup.getBoundingClientRect();\n      var top = rect.top + window.scrollY - popupRect.height - 8;\n      var left = rect.left + window.scrollX + (rect.width / 2) - (popupRect.width / 2);\n\n      // Keep within viewport\n      if (top < window.scrollY + 8) {\n        top = rect.bottom + window.scrollY + 8;\n      }\n      left = Math.max(8, Math.min(left, window.innerWidth - popupRect.width - 8));\n\n      popup.style.top = top + 'px';\n      popup.style.left = left + 'px';\n    }\n  }\n\n  function renderButtons() {\n    if (!popup) return;\n    currentState = 'buttons';\n\n    if (!isLoggedIn()) {\n      popup.innerHTML =\n        '<button class=\"ai-popup-btn ai-popup-btn--login\" data-action=\"login\">' +\n          escapeHtml(t.login) +\n        '</button>';\n    } else {\n      popup.innerHTML =\n        '<button class=\"ai-popup-btn ai-popup-btn--ask\" data-action=\"ask\">' +\n          escapeHtml(t.askAi) +\n        '</button>' +\n        '<button class=\"ai-popup-btn ai-popup-btn--edit\" data-action=\"edit\">' +\n          escapeHtml(t.edit) +\n        '</button>';\n    }\n  }\n\n  function renderLoading() {\n    if (!popup) return;\n    currentState = 'loading';\n\n    popup.innerHTML =\n      '<div class=\"ai-popup-loading\">' +\n        '<div class=\"ai-popup-spinner\"></div>' +\n        '<span>' + escapeHtml(t.loading) + '</span>' +\n      '</div>';\n  }\n\n  function renderAskResult(response) {\n    if (!popup) return;\n    currentState = 'ask-result';\n\n    var content = document.createElement('div');\n    content.className = 'ai-popup-result';\n\n    var closeBtn = document.createElement('button');\n    closeBtn.className = 'ai-popup-close';\n    closeBtn.setAttribute('data-action', 'close');\n    closeBtn.textContent = t.close;\n\n    var body = document.createElement('div');\n    body.className = 'ai-popup-result-body';\n    body.textContent = response;\n\n    content.appendChild(closeBtn);\n    content.appendChild(body);\n\n    popup.innerHTML = '';\n    popup.appendChild(content);\n\n    // Re-position for larger content\n    positionPopup(getSelectionRect() || { top: 0, left: 0, bottom: 0, width: 0 });\n  }\n\n  function renderEditResult(diff, editId) {\n    if (!popup) return;\n    currentState = 'edit-result';\n    pendingEditId = editId;\n\n    var content = document.createElement('div');\n    content.className = 'ai-popup-result';\n\n    var closeBtn = document.createElement('button');\n    closeBtn.className = 'ai-popup-close';\n    closeBtn.setAttribute('data-action', 'close');\n    closeBtn.textContent = t.close;\n\n    var diffEl = document.createElement('div');\n    diffEl.className = 'ai-popup-diff';\n\n    // Render diff lines\n    var lines = diff.split('\\n');\n    for (var i = 0; i < lines.length; i++) {\n      var line = lines[i];\n      var lineEl = document.createElement('div');\n      lineEl.className = 'ai-popup-diff-line';\n      if (line.indexOf('+') === 0 && line.indexOf('+++') !== 0) {\n        lineEl.className += ' ai-popup-diff-add';\n      } else if (line.indexOf('-') === 0 && line.indexOf('---') !== 0) {\n        lineEl.className += ' ai-popup-diff-remove';\n      }\n      lineEl.textContent = line;\n      diffEl.appendChild(lineEl);\n    }\n\n    var actions = document.createElement('div');\n    actions.className = 'ai-popup-actions';\n    actions.innerHTML =\n      '<button class=\"ai-popup-btn ai-popup-btn--confirm\" data-action=\"confirm\">' +\n        escapeHtml(t.confirm) +\n      '</button>' +\n      '<button class=\"ai-popup-btn ai-popup-btn--cancel\" data-action=\"close\">' +\n        escapeHtml(t.cancel) +\n      '</button>';\n\n    content.appendChild(closeBtn);\n    content.appendChild(diffEl);\n    content.appendChild(actions);\n\n    popup.innerHTML = '';\n    popup.appendChild(content);\n\n    positionPopup(getSelectionRect() || { top: 0, left: 0, bottom: 0, width: 0 });\n  }\n\n  function renderCommitted(commitHash) {\n    if (!popup) return;\n    currentState = 'committed';\n\n    popup.innerHTML =\n      '<div class=\"ai-popup-result\">' +\n        '<button class=\"ai-popup-close\" data-action=\"close\">' + escapeHtml(t.close) + '</button>' +\n        '<div class=\"ai-popup-committed\">' +\n          '<span class=\"ai-popup-committed-icon\">‚úÖ</span> ' +\n          escapeHtml(t.committed) +\n          (commitHash ? ' <code>' + escapeHtml(commitHash.substring(0, 7)) + '</code>' : '') +\n        '</div>' +\n      '</div>';\n  }\n\n  function renderError(msg) {\n    if (!popup) return;\n    currentState = 'error';\n\n    popup.innerHTML =\n      '<div class=\"ai-popup-result ai-popup-result--error\">' +\n        '<button class=\"ai-popup-close\" data-action=\"close\">' + escapeHtml(t.close) + '</button>' +\n        '<div class=\"ai-popup-error-text\">' + escapeHtml(msg || t.error) + '</div>' +\n      '</div>';\n  }\n\n  function getSelectionRect() {\n    var sel = window.getSelection();\n    if (!sel || sel.rangeCount === 0) return null;\n    var range = sel.getRangeAt(0);\n    var rect = range.getBoundingClientRect();\n    if (rect.width === 0 && rect.height === 0) return null;\n    return rect;\n  }\n\n  function isInsidePostContent(node) {\n    var el = node.nodeType === 3 ? node.parentElement : node;\n    while (el) {\n      if (el.classList && el.classList.contains('post-content')) return true;\n      el = el.parentElement;\n    }\n    return false;\n  }\n\n  async function apiRequest(endpoint, body) {\n    var jwt = getJwt();\n    var headers = { 'Content-Type': 'application/json' };\n    if (jwt) headers['Authorization'] = 'Bearer ' + jwt;\n\n    var res = await fetch(apiUrl + endpoint, {\n      method: 'POST',\n      headers: headers,\n      body: JSON.stringify(body)\n    });\n\n    if (!res.ok) {\n      var errText = '';\n      try { errText = (await res.json()).error || res.statusText; } catch(e) { errText = res.statusText; }\n      throw new Error(errText);\n    }\n\n    return res.json();\n  }\n\n  async function handleAsk() {\n    renderLoading();\n    try {\n      var data = await apiRequest('/ai/ask', {\n        text: selectedText,\n        context: postTitle\n      });\n      renderAskResult(data.response || data.answer || JSON.stringify(data));\n    } catch(err) {\n      renderError(err.message);\n    }\n  }\n\n  async function handleEdit() {\n    renderLoading();\n    try {\n      var data = await apiRequest('/ai/edit', {\n        text: selectedText,\n        filePath: filePath,\n        instruction: ''\n      });\n      renderEditResult(data.diff || '', data.editId || data.id || '');\n    } catch(err) {\n      renderError(err.message);\n    }\n  }\n\n  async function handleConfirm() {\n    renderLoading();\n    try {\n      var data = await apiRequest('/ai/edit/confirm', {\n        editId: pendingEditId\n      });\n      renderCommitted(data.commitHash || data.commit || '');\n    } catch(err) {\n      renderError(err.message);\n    }\n  }\n\n  function handleLogin() {\n    // Save current page URL so we can return after login\n    try {\n      localStorage.setItem(RETURN_KEY, window.location.href);\n    } catch(e) {}\n    window.location.href = apiUrl + '/auth/github';\n  }\n\n  // Event delegation for popup buttons\n  document.addEventListener('click', function(e) {\n    var btn = e.target.closest('[data-action]');\n    if (!btn || !popup || !popup.contains(btn)) return;\n\n    var action = btn.getAttribute('data-action');\n    e.stopPropagation();\n\n    switch (action) {\n      case 'ask':\n        handleAsk();\n        break;\n      case 'edit':\n        handleEdit();\n        break;\n      case 'confirm':\n        handleConfirm();\n        break;\n      case 'login':\n        handleLogin();\n        break;\n      case 'close':\n        removePopup();\n        break;\n    }\n  });\n\n  // Show popup on text selection in post-content\n  function onSelectionEnd(e) {\n    // Small delay to let selection finalize\n    setTimeout(function() {\n      var sel = window.getSelection();\n      var text = sel ? sel.toString().trim() : '';\n\n      if (!text || text.length < 2) {\n        // Don't remove if popup is showing results\n        if (currentState === 'buttons') {\n          removePopup();\n        }\n        return;\n      }\n\n      // Check if selection is inside .post-content\n      if (!sel.anchorNode || !isInsidePostContent(sel.anchorNode)) {\n        return;\n      }\n\n      selectedText = text;\n\n      var rect = getSelectionRect();\n      if (!rect) return;\n\n      createPopup();\n      renderButtons();\n      positionPopup(rect);\n    }, 10);\n  }\n\n  document.addEventListener('mouseup', onSelectionEnd);\n  document.addEventListener('touchend', onSelectionEnd);\n\n  // Close popup when clicking outside\n  document.addEventListener('mousedown', function(e) {\n    if (popup && !popup.contains(e.target)) {\n      // Only close for button state; keep results open\n      if (currentState === 'buttons') {\n        removePopup();\n      }\n    }\n  });\n\n  // Close on Escape\n  document.addEventListener('keydown', function(e) {\n    if (e.key === 'Escape' && popup) {\n      removePopup();\n    }\n  });\n})();\n"}