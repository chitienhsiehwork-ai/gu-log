#!/bin/sh
# Pre-commit hook for gu-log
#
# ALL checks are BLOCKING. Quality over speed.
# No LLM. All deterministic. All programmatic.
#
# Pipeline:
#   0) Quick ticketId duplicate check (~100ms, shell)
#   1) Post validator â€” frontmatter, content rules, cross-file checks (Node.js)
#   2) Content integrity BDD tests (Playwright, if available)

set -e
POSTS_DIR="src/content/posts"
SCRIPT_DIR="$(cd "$(dirname "$0")" && pwd)"
REPO_ROOT="$(git rev-parse --show-toplevel)"

# â”€â”€â”€ Step 0: Quick ticketId duplicate check (shell, ~100ms) â”€â”€â”€â”€â”€â”€â”€
echo "âš¡ Quick ticketId duplicate check..."
DUPLICATES=$(grep -h 'ticketId:' "$POSTS_DIR"/*.mdx 2>/dev/null | \
    sed 's/.*ticketId:[[:space:]]*["'"'"']\([^"'"'"']*\)["'"'"'].*/\1/' | \
    sort | uniq -c | sort -rn | awk '$1 > 2 {print $2 " (" $1 " occurrences)"}')

if [ -n "$DUPLICATES" ]; then
    echo ""
    echo "âŒ DUPLICATE ticketId DETECTED (more than 2 occurrences = not a translation pair):"
    echo "$DUPLICATES"
    echo ""
    echo "Each ticketId should appear exactly 2 times (zh-tw + en version)."
    exit 1
fi
echo "âœ“ No duplicate ticketIds"
echo ""

# â”€â”€â”€ Step 1: Post validator (Node.js, blocking) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# Validate only staged .mdx files (ACM = Added, Copied, Modified)
STAGED_MDX=$(git diff --cached --name-only --diff-filter=ACM -- "$POSTS_DIR"/*.mdx 2>/dev/null || true)

if [ -z "$STAGED_MDX" ]; then
    echo "âœ“ No .mdx files to validate"
else
    FILE_COUNT=$(echo "$STAGED_MDX" | wc -l | tr -d ' ')
    echo "ğŸ” Validating $FILE_COUNT staged .mdx file(s)..."

    # Build file list as arguments
    FILE_ARGS=""
    for file in $STAGED_MDX; do
        FILE_ARGS="$FILE_ARGS $REPO_ROOT/$file"
    done

    if ! node "$REPO_ROOT/scripts/validate-posts.mjs" $FILE_ARGS; then
        echo ""
        echo "âŒ Post validation FAILED. Fix errors above before committing."
        exit 1
    fi
fi
echo ""

# â”€â”€â”€ Step 2: Content integrity BDD tests (Playwright) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
if [ -f "$REPO_ROOT/tests/content-integrity.spec.ts" ]; then
    echo "ğŸ§ª Running content integrity tests..."
    if ! npx playwright test tests/content-integrity.spec.ts --project='Desktop Chrome' --reporter=line 2>&1; then
        echo ""
        echo "âŒ Content integrity tests FAILED."
        exit 1
    fi
    echo "âœ“ Content integrity tests passed"
    echo ""
fi

echo "âœ“ All pre-commit checks passed!"
exit 0
