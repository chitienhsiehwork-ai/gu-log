#!/bin/sh
# Pre-commit hook for gu-log
#
# ALL checks are BLOCKING. Quality over speed.
#
# Pipeline:
#   0) Quick ticketId duplicate check (~100ms, shell)
#   1) Post validator ‚Äî frontmatter, content rules, cross-file checks (Node.js)
#   1.5) translatedBy.model consistency check vs runtime model (Node.js)
#   2) Content integrity BDD tests (Playwright, if available)
#   3) Mermaid visual quality check ‚Äî LLM-as-Judge (if ANTHROPIC_API_KEY set)

set -e
POSTS_DIR="src/content/posts"
SCRIPT_DIR="$(cd "$(dirname "$0")" && pwd)"
REPO_ROOT="$(git rev-parse --show-toplevel)"

# ‚îÄ‚îÄ‚îÄ Step -1: Gitleaks secret scan (~500ms) ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
if command -v gitleaks >/dev/null 2>&1; then
    echo "üîê Gitleaks: scanning for secrets..."
    if ! gitleaks protect --staged --no-banner 2>&1; then
        echo ""
        echo "‚ùå SECRETS DETECTED! Do NOT commit."
        echo "   If false positive, add to .gitleaks.toml allowlist."
        exit 1
    fi
    echo "‚úì No secrets detected"
    echo ""
else
    echo "‚ö†Ô∏è  gitleaks not installed, skipping secret scan"
    echo ""
fi

# ‚îÄ‚îÄ‚îÄ Step 0: Quick ticketId duplicate check (shell, ~100ms) ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
echo "‚ö° Quick ticketId duplicate check..."
DUPLICATES=$(grep -h 'ticketId:' "$POSTS_DIR"/*.mdx 2>/dev/null | \
    sed 's/.*ticketId:[[:space:]]*["'"'"']\([^"'"'"']*\)["'"'"'].*/\1/' | \
    sort | uniq -c | sort -rn | awk '$1 > 2 {print $2 " (" $1 " occurrences)"}')

if [ -n "$DUPLICATES" ]; then
    echo ""
    echo "‚ùå DUPLICATE ticketId DETECTED (more than 2 occurrences = not a translation pair):"
    echo "$DUPLICATES"
    echo ""
    echo "Each ticketId should appear exactly 2 times (zh-tw + en version)."
    exit 1
fi
echo "‚úì No duplicate ticketIds"
echo ""

# ‚îÄ‚îÄ‚îÄ Step 0.5: ESLint check on staged files ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
STAGED_LINT=$(git diff --cached --name-only --diff-filter=ACM -- '*.ts' '*.tsx' '*.astro' '*.mjs' 2>/dev/null || true)

if [ -z "$STAGED_LINT" ]; then
    echo "‚úì No lintable files staged"
else
    LINT_COUNT=$(echo "$STAGED_LINT" | wc -l | tr -d ' ')
    echo "üîç ESLint: checking $LINT_COUNT staged file(s)..."

    LINT_FILES=""
    for file in $STAGED_LINT; do
        if [ -f "$REPO_ROOT/$file" ]; then
            LINT_FILES="$LINT_FILES $REPO_ROOT/$file"
        fi
    done

    if [ -n "$LINT_FILES" ]; then
        # --max-warnings=-1 means unlimited warnings; we only block on errors
        if ! npx eslint --no-warn-ignored $LINT_FILES 2>&1; then
            LINT_EXIT=$?
            # eslint exit code 1 = lint errors found
            if [ "$LINT_EXIT" -eq 1 ]; then
                echo ""
                echo "‚ùå ESLint found errors. Fix them before committing."
                echo "   Run: pnpm run lint:fix"
                exit 1
            fi
        fi
        echo "‚úì ESLint passed"
    fi
fi
echo ""

# ‚îÄ‚îÄ‚îÄ Step 1: Post validator (Node.js, blocking) ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
# Validate only staged .mdx files (ACM = Added, Copied, Modified)
STAGED_MDX=$(git diff --cached --name-only --diff-filter=ACM -- "$POSTS_DIR"/*.mdx 2>/dev/null || true)

if [ -z "$STAGED_MDX" ]; then
    echo "‚úì No .mdx files to validate"
else
    FILE_COUNT=$(echo "$STAGED_MDX" | wc -l | tr -d ' ')
    echo "üîç Validating $FILE_COUNT staged .mdx file(s)..."

    # Build file list as arguments
    FILE_ARGS=""
    for file in $STAGED_MDX; do
        FILE_ARGS="$FILE_ARGS $REPO_ROOT/$file"
    done

    if ! node "$REPO_ROOT/scripts/validate-posts.mjs" $FILE_ARGS; then
        echo ""
        echo "‚ùå Post validation FAILED. Fix errors above before committing."
        exit 1
    fi
fi
echo ""

# ‚îÄ‚îÄ‚îÄ Step 1.5: translatedBy.model runtime consistency (blocking) ‚îÄ
if [ -n "$STAGED_MDX" ]; then
    FILE_ARGS=""
    for file in $STAGED_MDX; do
        FILE_ARGS="$FILE_ARGS $REPO_ROOT/$file"
    done

    if ! node "$REPO_ROOT/scripts/check-translatedby-model.mjs" $FILE_ARGS; then
        echo ""
        echo "‚ùå translatedBy.model consistency check FAILED."
        echo "   Fix frontmatter model names or ensure OPENCLAW_MODEL mapping is correct."
        exit 1
    fi
fi
echo ""

# ‚îÄ‚îÄ‚îÄ Step 2: Content integrity BDD tests (Playwright) ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
if [ -f "$REPO_ROOT/tests/content-integrity.spec.ts" ]; then
    echo "üß™ Running content integrity tests..."
    if ! npx playwright test tests/content-integrity.spec.ts --project='Desktop Chrome' --reporter=line 2>&1; then
        echo ""
        echo "‚ùå Content integrity tests FAILED."
        exit 1
    fi
    echo "‚úì Content integrity tests passed"
    echo ""
fi

# ‚îÄ‚îÄ‚îÄ Step 3: Mermaid visual quality check (LLM-as-Judge) ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
# Only runs if ANTHROPIC_API_KEY is set and staged .mdx files contain Mermaid
if [ -n "$ANTHROPIC_API_KEY" ]; then
    # Find staged .mdx files that contain <Mermaid
    MERMAID_FILES=""
    if [ -n "$STAGED_MDX" ]; then
        for file in $STAGED_MDX; do
            if [ -f "$REPO_ROOT/$file" ] && grep -q '<Mermaid' "$REPO_ROOT/$file" 2>/dev/null; then
                MERMAID_FILES="$MERMAID_FILES $REPO_ROOT/$file"
            fi
        done
    fi

    if [ -z "$MERMAID_FILES" ]; then
        echo "‚úì No Mermaid diagrams in staged files"
    else
        MERMAID_COUNT=$(echo "$MERMAID_FILES" | wc -w | tr -d ' ')
        echo "üìê Mermaid visual check: $MERMAID_COUNT file(s) with diagrams..."

        if ! node "$REPO_ROOT/scripts/check-mermaid-visual.mjs" --files $MERMAID_FILES; then
            echo ""
            echo "‚ùå Mermaid visual quality check FAILED."
            echo "   Some diagrams are not readable on mobile (iPhone 14, 390px)."
            echo "   Run 'pnpm run check:mermaid' for a full report with screenshots."
            exit 1
        fi
        echo "‚úì Mermaid visual check passed"
    fi
    echo ""
else
    echo "‚ÑπÔ∏è  Skipping Mermaid visual check (ANTHROPIC_API_KEY not set)"
    echo ""
fi

echo "‚úì All pre-commit checks passed!"
exit 0
