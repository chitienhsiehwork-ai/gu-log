name: Post-Deploy Smoke Test

on:
  deployment_status:

jobs:
  smoke-test:
    # Only run when Vercel deployment succeeds (or fails)
    if: github.event.deployment.environment == 'Production'
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Report deployment failure
        if: github.event.deployment_status.state == 'failure'
        run: |
          echo "::error::üö® Vercel deployment FAILED for commit ${{ github.event.deployment.sha }}"
          echo "Deployment URL: ${{ github.event.deployment_status.target_url }}"
          exit 1

      - name: Notify Telegram ‚Äî deploy failed
        if: github.event.deployment_status.state == 'failure' && always()
        env:
          TG_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          TG_CHAT: ${{ secrets.TELEGRAM_CHAT_ID }}
        run: |
          [ -z "$TG_TOKEN" ] && echo "No TG token, skip" && exit 0
          MSG="üö® *Vercel Deploy FAILED*%0A%0ACommit: \`${GITHUB_SHA::7}\`%0AURL: ${{ github.event.deployment_status.target_url }}%0A%0A‰øÆ‰∏Ä‰∏ãÂêß ShroomDog üêæ"
          curl -s -X POST "https://api.telegram.org/bot${TG_TOKEN}/sendMessage" \
            -d chat_id="${TG_CHAT}" \
            -d message_thread_id=4 \
            -d parse_mode=Markdown \
            -d text="${MSG}" > /dev/null

      - name: Wait for deployment to propagate
        if: github.event.deployment_status.state == 'success'
        run: sleep 15

      - name: Smoke test ‚Äî check site is up
        if: github.event.deployment_status.state == 'success'
        run: |
          STATUS=$(curl -s -o /dev/null -w "%{http_code}" "https://gu-log.vercel.app")
          if [ "$STATUS" != "200" ]; then
            echo "::error::üö® Homepage returned HTTP $STATUS"
            exit 1
          fi
          echo "‚úÖ Homepage: 200"

      - name: Smoke test ‚Äî check latest articles are live
        if: github.event.deployment_status.state == 'success'
        run: |
          FAILED=0
          TOTAL=0
          
          # Get all non-English post slugs, sorted by date (newest first), take top 10
          for f in $(ls src/content/posts/*.mdx | grep -v 'en-' | sort -r | head -10); do
            slug=$(basename "$f" .mdx)
            URL="https://gu-log.vercel.app/posts/$slug"
            STATUS=$(curl -s -o /dev/null -w "%{http_code}" "$URL")
            TOTAL=$((TOTAL + 1))
            
            if [ "$STATUS" != "200" ]; then
              echo "::error::‚ùå $slug ‚Üí HTTP $STATUS"
              FAILED=$((FAILED + 1))
            else
              echo "‚úÖ $slug ‚Üí 200"
            fi
          done
          
          echo ""
          echo "=== Results: $((TOTAL - FAILED))/$TOTAL passed ==="
          
          if [ "$FAILED" -gt 0 ]; then
            echo "::error::üö® $FAILED of $TOTAL articles returned non-200 status!"
            exit 1
          fi

      - name: Smoke test ‚Äî check Clawd Picks listing page
        if: github.event.deployment_status.state == 'success'
        run: |
          STATUS=$(curl -s -o /dev/null -w "%{http_code}" "https://gu-log.vercel.app/clawd-picks")
          if [ "$STATUS" != "200" ]; then
            echo "::error::üö® Clawd Picks page returned HTTP $STATUS"
            exit 1
          fi
          echo "‚úÖ Clawd Picks listing: 200"

      - name: Smoke test ‚Äî check article count matches repo
        if: github.event.deployment_status.state == 'success'
        run: |
          # Count non-English posts in repo
          REPO_COUNT=$(ls src/content/posts/*.mdx | grep -v 'en-' | wc -l)
          
          # Fetch the homepage and count post links (rough check)
          BODY=$(curl -s "https://gu-log.vercel.app/clawd-picks")
          # Count <a> links to /posts/ on the listing page
          LIVE_COUNT=$(echo "$BODY" | grep -o 'href="/posts/' | wc -l)
          
          echo "Repo posts: $REPO_COUNT"
          echo "Live Clawd Picks links: $LIVE_COUNT"
          
          # Allow some slack (SP posts won't be on CP page), but CP count should match
          CP_REPO=$(ls src/content/posts/clawd-picks-*.mdx | grep -v 'en-' | wc -l)
          echo "Repo CP posts: $CP_REPO"
          
          DIFF=$((CP_REPO - LIVE_COUNT))
          if [ "$DIFF" -gt 2 ] || [ "$DIFF" -lt -2 ]; then
            echo "::warning::‚ö†Ô∏è CP count mismatch: repo=$CP_REPO vs live=$LIVE_COUNT (diff=$DIFF)"
          else
            echo "‚úÖ CP count matches (repo=$CP_REPO, live=$LIVE_COUNT)"
          fi

      - name: Notify Telegram ‚Äî smoke test failed
        if: failure() && github.event.deployment_status.state == 'success'
        env:
          TG_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          TG_CHAT: ${{ secrets.TELEGRAM_CHAT_ID }}
        run: |
          [ -z "$TG_TOKEN" ] && echo "No TG token, skip" && exit 0
          MSG="‚ö†Ô∏è *Smoke Test FAILED*%0A%0ADeploy ÊàêÂäü‰ΩÜ smoke test Ê≤íÈÅéÔºÅ%0ACommit: \`${GITHUB_SHA::7}\`%0A%0A[Êü•Áúã CI](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})"
          curl -s -X POST "https://api.telegram.org/bot${TG_TOKEN}/sendMessage" \
            -d chat_id="${TG_CHAT}" \
            -d message_thread_id=4 \
            -d parse_mode=Markdown \
            -d text="${MSG}" > /dev/null
